// 멤버 삭제
        function deleteMember(name) {
            if (!confirm("'" + name + "' 멤버를 정말 삭제하시겠습니까?")) {
                return;
            }

            // 현재 선택된 멤버 저장
            var currentSelectedMemberName = null;
            if (memberList.length > 0 && selectedMemberIndex >= 0 && selectedMemberIndex < memberList.length) {
                currentSelectedMemberName = memberList[selectedMemberIndex];
            }

            fetch('/api/member/' + currentYear + '/' + currentMonth + '/' + encodeURIComponent(name), {
                method: 'DELETE'
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    // 삭제된 멤버가 현재 선택된 멤버인 경우 첫 번째 멤버로 변경
                    if (currentSelectedMemberName === name) {
                        selectedMemberIndex = 0;
                        loadCurrentMonthWithSync();
                    } else {
                        // 다른 멤버가 선택된 경우 선택 유지
                        loadCurrentMonthWithSync(currentSelectedMemberName);
                    }
                } else {
                    alert('멤버 삭제에 실패했습니다.');
                }
            })
            .catch(function(error) {
                alert('네트워크 오류가 발생했습니다: ' + error);
            });
        }

        // 역할 변경 완료 후 업데이트
        function updateMemberRole() {
            if (!editingMember) return;

            // 현재 선택된 멤버 저장
            var currentSelectedMemberName = null;
            if (memberList.length > 0 && selectedMemberIndex >= 0 && selectedMemberIndex < memberList.length) {
                currentSelectedMemberName = memberList[selectedMemberIndex];
            }

            var newRole = document.getElementById('newRole').value;

            fetch('/api/member_role', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth,
                    name: editingMember,
                    role: newRole
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    closeRoleModal();
                    // 역할 변경 후 선택 유지하면서 업데이트
                    loadCurrentMonthWithSync(currentSelectedMemberName);
                } else {
                    alert('역할 변경에 실패했습니다.');
                }
            })
            .catch(function(error) {
                alert('네트워크 오류가 발생했습니다: ' + error);
            });
        }

        // 멤버 관리와 출석 현황을 동기화하여 로드
        function loadCurrentMonthWithSync(selectedMemberName) {
            // 멤버 관리 먼저 로드
            loadMemberManagement();

            // 출석 현황을 선택된 멤버와 함께 로드
            if (selectedMemberName) {
                loadAttendanceTableWithMemberSelection(selectedMemberName);
            } else {
                loadAttendanceTable();
            }
        }

        // 역할 변경 모달
        function openRoleModal(name, currentRole) {
            editingMember = name;
            document.getElementById('roleModalMemberName').textContent = name + '의 역할 변경';
            document.getElementById('newRole').value = currentRole;
            document.getElementById('roleModal').style.display = 'block';
        }

        function closeRoleModal() {
            document.getElementById('roleModal').style.display = 'none';
            editingMember = null;
        }

        // 멤버 관리 로드
        function loadMemberManagement() {
            var container = document.getElementById('memberManagement');
            container.innerHTML = '<div class="loading">멤버 목록을 불러오는 중입니다...</div>';

            fetch('/api/members/' + currentYear + '/' + currentMonth)
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                currentMembers = data;
                displayMemberManagement(data);
            })
            .catch(function(error) {
                container.innerHTML = '<div class="error">멤버 목록을 불러오는 중 오류가 발생했습니다: ' + error + '</div>';
            });
        }

        // 멤버 관리 화면 표시
        function displayMemberManagement(members) {
            var container = document.getElementById('memberManagement');

            if (Object.keys(members).length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><h3>등록된 멤버가 없습니다</h3><p>위의 "멤버 추가" 섹션에서 새 멤버를 추가하거나 "전월 멤버 복사" 버튼을 사용하세요.</p></div>';
                return;
            }

            // 멤버를 order 순으로 정렬
            var memberEntries = Object.keys(members);
            memberEntries.sort(function(a, b) {
                var orderA = members[a].order || 0;
                var orderB = members[b].order || 0;
                return orderA - orderB;
            });

            var html = '<div class="member-management" id="sortable-members">';

            for (var i = 0; i < memberEntries.length; i++) {
                var name = memberEntries[i];
                var member = members[name];

                html += '<div class="member-card" data-member-name="' + name + '">';
                html += '<div class="drag-handle" title="드래그하여 순서 변경">⋮⋮</div>';
                html += '<div class="member-info">';
                html += '<div class="member-name">' + name + '</div>';
                html += '<div class="member-role">' + member.role + '</div>';
                html += '</div>';
                html += '<div class="member-actions">';
                html += '<button class="btn-warning" onclick="openRoleModal(\'' + name + '\', \'' + member.role + '\')">역할 변경</button>';
                html += '<button class="btn-danger" onclick="deleteMember(\'' + name + '\')">삭제</button>';
                html += '</div>';
                html += '</div>';
            }

            html += '</div>';
            container.innerHTML = html;

            // Sortable 초기화
            setTimeout(function() {
                initializeSortable();
            }, 100);
        }

        // Sortable 초기화
        function initializeSortable() {
            var memberContainer = document.querySelector('#sortable-members');

            if (!memberContainer) return;
            if (typeof Sortable === 'undefined') return;

            if (memberContainer.sortableInstance) {
                memberContainer.sortableInstance.destroy();
            }

            memberContainer.sortableInstance = Sortable.create(memberContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                handle: '.drag-handle',
                onEnd: function(evt) {
                    if (evt.oldIndex !== evt.newIndex) {
                        updateMemberOrderByDrag(evt.oldIndex, evt.newIndex);
                    }
                }
            });
        }

        // 드래그로 순서 변경
        function updateMemberOrderByDrag(oldIndex, newIndex) {
            var memberNames = Object.keys(currentMembers);
            memberNames.sort(function(a, b) {
                var orderA = currentMembers[a].order || 0;
                var orderB = currentMembers[b].order || 0;
                return orderA - orderB;
            });

            // 현재 선택된 멤버 이름 저장 (카드뷰용)
            var currentSelectedMemberName = null;
            if (memberList.length > 0 && selectedMemberIndex >= 0 && selectedMemberIndex < memberList.length) {
                currentSelectedMemberName = memberList[selectedMemberIndex];
            }

            // 배열에서 요소 이동
            var movedMember = memberNames.splice(oldIndex, 1)[0];
            memberNames.splice(newIndex, 0, movedMember);

            // 새로운 order 값들 생성
            var orders = [];
            for (var i = 0; i < memberNames.length; i++) {
                orders.push({
                    name: memberNames[i],
                    order: i
                });
            }

            // 서버에 업데이트 요청
            fetch('/api/member_orders', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth,
                    orders: orders
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    // 멤버 관리와 출석 현황 모두 업데이트
                    loadMemberManagement();

                    // 출석 현황도 업데이트하되, 카드뷰에서 선택된 멤버 유지
                    loadAttendanceTableWithMemberSelection(currentSelectedMemberName);
                } else {
                    alert('순서 변경에 실패했습니다.');
                    loadCurrentMonth();
                }
            })
            .catch(function(error) {
                alert('네트워크 오류가 발생했습니다: ' + error);
                loadCurrentMonth();
            });
        }

        // 선택된 멤버를 유지하면서 출석 테이블 로드
        function loadAttendanceTableWithMemberSelection(selectedMemberName) {
            var container = document.getElementById('attendanceTable');
            container.innerHTML = '<div class="loading">출석 데이터를 불러오는 중입니다...</div>';

            fetch('/api/monthly_report/' + currentYear + '/' + currentMonth)
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                // Export용 데이터 저장
                currentReportData = data;

                // 새로운 순서로 멤버 리스트 업데이트
                var memberEntries = Object.keys(data.members || data);
                memberEntries.sort(function(a, b) {
                    var dataObj = data.members || data;
                    var orderA = dataObj[a].order || 0;
                    var orderB = dataObj[b].order || 0;
                    return orderA - orderB;
                });

                // 이전에 선택된 멤버의 새로운 인덱스 찾기
                if (selectedMemberName && memberEntries.indexOf(selectedMemberName) !== -1) {
                    selectedMemberIndex = memberEntries.indexOf(selectedMemberName);
                } else {
                    // 이전 선택이 없거나 해당 멤버가 없으면 첫 번째 멤버 선택
                    selectedMemberIndex = 0;
                }

                displayAttendanceTable(data, currentYear, currentMonth);
            })
            .catch(function(error) {
                container.innerHTML = '<div class="error">데이터를 불러오는 중 오류가 발생했습니다: ' + error + '</div>';
            });
        }

        // 출석 테이블 로드
        function loadAttendanceTable() {
            var container = document.getElementById('attendanceTable');
            container.innerHTML = '<div class="loading">출석 데이터를 불러오는 중입니다...</div>';

            fetch('/api/monthly_report/' + currentYear + '/' + currentMonth)
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                // Export용 데이터 저장
                currentReportData = data;
                displayAttendanceTable(data, currentYear, currentMonth);
            })
            .catch(function(error) {
                container.innerHTML = '<div class="error">데이터를 불러오는 중 오류가 발생했습니다: ' + error + '</div>';
            });
        }

        // 출석 테이블 표시
        function displayAttendanceTable(responseData, year, month) {
            var container = document.getElementById('attendanceTable');
            var data = responseData.members || responseData;
            var dates = responseData.dates || [];

            if (Object.keys(data).length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><h3>등록된 멤버가 없습니다</h3><p>위의 "멤버 추가" 섹션에서 새 멤버를 추가하거나 "전월 멤버 복사" 버튼을 사용하세요.</p></div>';
                return;
            }

            // 멤버를 order 순으로 정렬
            var memberEntries = Object.keys(data);
            memberEntries.sort(function(a, b) {
                var orderA = data[a].order || 0;
                var orderB = data[b].order || 0;
                return orderA - orderB;
            });

            // 날짜가 없으면 첫 번째 멤버의 출석 데이터에서 추출
            var finalDates = dates;
            if (finalDates.length === 0 && memberEntries.length > 0) {
                finalDates = Object.keys(data[memberEntries[0]].attendance || {}).sort();
            }

            var html = '';

            // 현재 사용할 뷰 결정
            var viewToUse = getCurrentView();

            // 뷰 토글 버튼 (PC와 모바일 모두 표시)
            html += '<div class="view-toggle">';

            if (viewToUse === 'table') {
                html += '<button id="tableViewBtn" class="active" onclick="switchToTableView()">📊 테이블 뷰</button>';
                html += '<button id="cardViewBtn" onclick="switchToCardView()">📋 카드 뷰</button>';
            } else {
                html += '<button id="tableViewBtn" onclick="switchToTableView()">📊 테이블 뷰</button>';
                html += '<button id="cardViewBtn" class="active" onclick="switchToCardView()">📋 카드 뷰</button>';
            }

            html += '</div>';

            // 데스크톱 테이블 뷰
            html += '<div class="desktop-view"' + (viewToUse === 'table' ? '' : ' style="display: none;"') + '>';
            html += generateTableView(data, memberEntries, finalDates, year, month);
            html += '</div>';

            // 모바일 카드 뷰
            html += '<div class="mobile-view"' + (viewToUse === 'card' ? '' : ' style="display: none;"') + '>';
            html += generateCardView(data, memberEntries, finalDates, year, month);
            html += '</div>';

            // 범례 추가
            html += '<div style="margin-top: 30px; padding: 25px; background: #f8f9fa; border-radius: 10px;">';
            html += '<h3>📋 출석 조건 및 사용법</h3>';
            html += '<ul style="list-style: none; margin: 15px 0;">';
            html += '<li style="padding: 5px 0;">▶ <strong>운영진:</strong> 출석 조건 없음</li>';
            html += '<li style="padding: 5px 0;">▶ <strong>페이서:</strong> 월 3회 이상 출석</li>';
            html += '<li style="padding: 5px 0;">▶ <strong>페이서 강남:</strong> 월 3회 이상 출석 (그 중 수요일 2회 이상)</li>';
            html += '<li style="padding: 5px 0;">▶ <strong>포토:</strong> 월 1회 이상 출석</li>';
            html += '</ul>';
            html += '<div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin-top: 15px; border-radius: 0 8px 8px 0;">';
            html += '<p style="margin: 5px 0; color: #1565c0;"><strong>💡 사용법:</strong></p>';
            html += '<p style="margin: 5px 0; color: #1565c0;">• 출석 셀을 클릭하면 출석/불참이 토글됩니다</p>';
            html += '<p style="margin: 5px 0; color: #1565c0;">• 초록색 배경: 출석 조건 충족 ✅</p>';
            html += '<p style="margin: 5px 0; color: #1565c0;">• 빨간색 배경: 출석 조건 미충족 ❌</p>';
            if (isMobile()) {
                html += '<p style="margin: 5px 0; color: #1565c0;">• 📱 모바일: 기본 카드 뷰, 멤버별 개별 확인</p>';
            } else {
                html += '<p style="margin: 5px 0; color: #1565c0;">• 🖥️ PC: 기본 테이블 뷰, 전체 한눈에 확인</p>';
            }
            html += '</div>';
            html += '</div>';

            container.innerHTML = html;

            // 현재 뷰 상태 설정
            currentView = viewToUse;
        }

        // 테이블 뷰 생성
        function generateTableView(data, memberEntries, finalDates, year, month) {
            var isMobile = window.innerWidth <= 768;
            var html = '';

            if (isMobile && finalDates.length > 4) {
                html += '<div style="text-align: center; color: #666; font-size: 0.9em; margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px;">📱 표를 좌우로 스크롤하여 모든 날짜를 확인하세요</div>';
            }

            html += '<div class="table-container">';
            html += '<table class="attendance-table">';

            // 헤더
            html += '<thead><tr>';
            html += '<th style="min-width: 60px;">직책</th>';
            html += '<th style="min-width: 80px;">성명</th>';
            html += '<th style="min-width: 50px;">합계</th>';

            for (var i = 0; i < finalDates.length; i++) {
                var date = finalDates[i];
                var dateObj = new Date(date);
                var weekdays = ['일', '월', '화', '수', '목', '금', '토'];
                var weekday = weekdays[dateObj.getDay()];
                var day = dateObj.getDate();
                html += '<th style="min-width: 50px;">' + month + '월<br>' + day + '일<br>' + weekday + '</th>';
            }
            html += '</tr></thead>';

            // 바디
            html += '<tbody>';
            for (var memberIndex = 0; memberIndex < memberEntries.length; memberIndex++) {
                var name = memberEntries[memberIndex];
                var info = data[name];

                if (!info || !info.stats) continue;

                var stats = info.stats;
                var rowClass = stats.meets_requirement ? 'pass' : 'fail';

                html += '<tr class="' + rowClass + '">';
                html += '<td><strong>' + (info.role || '미정') + '</strong></td>';
                html += '<td><strong>' + name + '</strong></td>';
                html += '<td><strong>' + (stats.total || 0) + '</strong></td>';

                for (var dateIndex = 0; dateIndex < finalDates.length; dateIndex++) {
                    var date = finalDates[dateIndex];
                    var attendance = info.attendance || {};
                    var status = attendance[date] || 0;
                    var cellClass = status === 1 ? 'present' : 'absent';
                    var displayText = status === 1 ? '1' : '0';

                    html += '<td class="attendance-cell ' + cellClass + '" onclick="toggleAttendance(\'' + name + '\', \'' + date + '\', this)" title="' + name + ' - ' + date + ' 클릭하여 변경">';
                    html += displayText;
                    html += '</td>';
                }
                html += '</tr>';
            }
            html += '</tbody></table></div>';

            return html;
        }

        // 카드 뷰 생성 - 선택된 멤버만 표시
        function generateCardView(data, memberEntries, finalDates, year, month) {
            memberList = memberEntries; // 전역 변수에 저장

            var html = '';

            // 멤버 선택 드롭다운
            html += '<div class="member-selector">';
            html += '<label>👤 멤버 선택:</label>';
            html += '<select id="memberSelect" onchange="changeMember()">';
            for (var i = 0; i < memberEntries.length; i++) {
                var name = memberEntries[i];
                var selected = i === selectedMemberIndex ? ' selected' : '';
                html += '<option value="' + i + '"' + selected + '>' + name + '</option>';
            }
            html += '</select>';
            html += '</div>';

            // 네비게이션 버튼
            html += '<div class="card-navigation">';
            html += '<button class="nav-button" onclick="previousMember()" ' + (selectedMemberIndex <= 0 ? 'disabled' : '') + '>← 이전</button>';
            html += '<div class="member-indicator">' + (selectedMemberIndex + 1) + ' / ' + memberEntries.length + '</div>';
            html += '<button class="nav-button" onclick="nextMember()" ' + (selectedMemberIndex >= memberEntries.length - 1 ? 'disabled' : '') + '>다음 →</button>';
            html += '</div>';

            // 선택된 멤버 카드 표시
            html += '<div class="single-card-container">';

            if (memberEntries.length === 0) {
                html += '<div class="no-member-selected">';
                html += '<h3>등록된 멤버가 없습니다</h3>';
                html += '<p>멤버를 추가해주세요.</p>';
                html += '</div>';
            } else if (selectedMemberIndex >= 0 && selectedMemberIndex < memberEntries.length) {
                var name = memberEntries[selectedMemberIndex];
                var info = data[name];

                if (info && info.stats) {
                    var stats = info.stats;
                    var cardClass = stats.meets_requirement ? 'pass' : 'fail';

                    html += '<div class="member-card-view ' + cardClass + '" style="width: 100%; max-width: 600px;">';

                    // 멤버 헤더
                    html += '<div class="member-header-mobile">';
                    html += '<div class="member-name-mobile">' + name + '</div>';
                    html += '<div class="member-role-mobile">' + (info.role || '미정') + '</div>';
                    html += '</div>';

                    // 통계
                    html += '<div class="member-stats-mobile">';
                    html += '<div class="stat-item">';
                    html += '<div class="stat-label">총 출석</div>';
                    html += '<div class="stat-value">' + (stats.total || 0) + '회</div>';
                    html += '</div>';
                    html += '<div class="stat-item">';
                    html += '<div class="stat-label">수요일 출석</div>';
                    html += '<div class="stat-value">' + (stats.wednesday || 0) + '회</div>';
                    html += '</div>';
                    html += '<div class="stat-item">';
                    html += '<div class="stat-label">조건 충족</div>';
                    html += '<div class="stat-value">' + (stats.meets_requirement ? '✅' : '❌') + '</div>';
                    html += '</div>';
                    html += '</div>';

                    // 출석 그리드
                    html += '<div class="attendance-grid-mobile">';
                    for (var dateIndex = 0; dateIndex < finalDates.length; dateIndex++) {
                        var date = finalDates[dateIndex];
                        var dateObj = new Date(date);
                        var weekdays = ['일', '월', '화', '수', '목', '금', '토'];
                        var weekday = weekdays[dateObj.getDay()];
                        var day = dateObj.getDate();

                        var attendance = info.attendance || {};
                        var status = attendance[date] || 0;
                        var itemClass = status === 1 ? 'present' : 'absent';
                        var displayText = status === 1 ? '출석' : '불참';

                        html += '<div class="attendance-item-mobile ' + itemClass + '" onclick="toggleAttendance(\'' + name + '\', \'' + date + '\', this)" title="' + name + ' - ' + date + ' 클릭하여 변경">';
                        html += '<div class="date-label-mobile">' + month + '/' + day + '<br>' + weekday + '</div>';
                        html += '<div class="attendance-value-mobile">' + displayText + '</div>';
                        html += '</div>';
                    }
                    html += '</div>';

                    html += '</div>';
                }
            }

            html += '</div>';

            return html;
        }

        // 멤버 네비게이션 함수들
        function previousMember() {
            if (selectedMemberIndex > 0) {
                selectedMemberIndex--;
                updateCardViewOnly(); // 카드뷰만 업데이트, 뷰 변경 안함
            }
        }

        function nextMember() {
            if (selectedMemberIndex < memberList.length - 1) {
                selectedMemberIndex++;
                updateCardViewOnly(); // 카드뷰만 업데이트, 뷰 변경 안함
            }
        }

        function changeMember() {
            var select = document.getElementById('memberSelect');
            if (select) {
                selectedMemberIndex = parseInt(select.value);
                updateCardViewOnly(); // 카드뷰만 업데이트, 뷰 변경 안함
            }
        }

        // 카드 뷰만 업데이트 (뷰 변경 없이)
        function updateCardViewOnly() {
            // 현재 선택된 멤버 이름 저장
            var currentSelectedMemberName = null;
            if (memberList.length > 0 && selectedMemberIndex >= 0 && selectedMemberIndex < memberList.length) {
                currentSelectedMemberName = memberList[selectedMemberIndex];
            }

            // 카드뷰 부분만 업데이트
            var mobileView = document.querySelector('.mobile-view');
            if (mobileView && currentView === 'card') {
                // 현재 데이터로 카드뷰 내용만 다시 생성
                fetch('/api/monthly_report/' + currentYear + '/' + currentMonth)
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    var memberEntries = Object.keys(data.members || data);
                    memberEntries.sort(function(a, b) {
                        var dataObj = data.members || data;
                        var orderA = dataObj[a].order || 0;
                        var orderB = dataObj[b].order || 0;
                        return orderA - orderB;
                    });

                    var finalDates = data.dates || [];
                    if (finalDates.length === 0 && memberEntries.length > 0) {
                        finalDates = Object.keys((data.members || data)[memberEntries[0]].attendance || {}).sort();
                    }

                    var cardViewHTML = generateCardView(data.members || data, memberEntries, finalDates, currentYear, currentMonth);
                    mobileView.innerHTML = cardViewHTML;
                })
                .catch(function(error) {
                    console.error('카드뷰 업데이트 오류:', error);
                });
            }
        }

        // 뷰 전환 함수들
        function switchToCardView() {
            var desktopView = document.querySelector('.desktop-view');
            var mobileView = document.querySelector('.mobile-view');
            var cardBtn = document.getElementById('cardViewBtn');
            var tableBtn = document.getElementById('tableViewBtn');

            if (desktopView) {
                desktopView.style.display = 'none';
                desktopView.classList.add('inactive');
            }
            if (mobileView) {
                mobileView.style.display = 'block';
                mobileView.classList.add('active');
            }
            if (cardBtn) cardBtn.classList.add('active');
            if (tableBtn) tableBtn.classList.remove('active');

            currentView = 'card';
            userSelectedView = 'card'; // 사용자가 직접 선택했음을 기록

            // 카드 뷰로 전환 시 첫 번째 멤버 선택 (인덱스가 범위를 벗어나는 경우만)
            if (selectedMemberIndex < 0 || selectedMemberIndex >= memberList.length) {
                selectedMemberIndex = 0;
            }
        }

        function switchToTableView() {
            var desktopView = document.querySelector('.desktop-view');
            var mobileView = document.querySelector('.mobile-view');
            var cardBtn = document.getElementById('cardViewBtn');
            var tableBtn = document.getElementById('tableViewBtn');

            if (desktopView) {
                desktopView.style.display = 'block';
                desktopView.classList.remove('inactive');
            }
            if (mobileView) {
                mobileView.style.display = 'none';
                mobileView.classList.remove('active');
            }
            if (tableBtn) tableBtn.classList.add('active');
            if (cardBtn) cardBtn.classList.remove('active');

            currentView = 'table';
            userSelectedView = 'table'; // 사용자가 직접 선택했음을 기록
        }

        // 출석 토글
        function toggleAttendance(name, date, cell) {
            var currentStatus = cell.classList.contains('present') ? 1 : 0;
            var newStatus = currentStatus === 1 ? 0 : 1;

            fetch('/api/attendance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth,
                    name: name,
                    date: date,
                    status: newStatus
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    // 즉시 셀 상태 업데이트
                    cell.classList.remove('present', 'absent');
                    cell.classList.add(newStatus === 1 ? 'present' : 'absent');

                    // 텍스트 업데이트
                    var valueElement = cell.querySelector('.attendance-value-mobile');
                    if (valueElement) {
                        valueElement.textContent = newStatus === 1 ? '출석' : '불참';
                    } else {
                        cell.textContent = newStatus === 1 ? '1' : '0';
                    }

                    // 통계 업데이트를 위해 테이블 다시 로드
                    setTimeout(function() {
                        loadAttendanceTable();
                    }, 100);
                } else {
                    alert('출석 정보 업데이트에 실패했습니다.');
                }
            })
            .catch(function(error) {
                alert('네트워크 오류가 발생했습니다: ' + error);
            });
        }

        // 메시지 표시
        function showMessage(message, type, container) {
            container.innerHTML = '<div class="' + type + '">' + message + '</div>';
            setTimeout(function() {
                container.innerHTML = '';
            }, 5000);
        }

        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            var modal = document.getElementById('roleModal');
            if (event.target === modal) {
                closeRoleModal();
            }
        };

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthenticationStatus();
            
            // 암호 입력 필드 설정
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleLogin(e);
                    }
                });
                passwordInput.focus();
            }
        });
    </script>
</body>
</html>        
        // Excel 데이터 생성
        function generateExcelData(reportData) {
            var data = reportData.members || reportData;
            var dates = reportData.dates || [];
            
            // 멤버를 order 순으로 정렬
            var memberEntries = Object.keys(data);
            memberEntries.sort(function(a, b) {
                var orderA = data[a].order || 0;
                var orderB = data[b].order || 0;
                return orderA - orderB;
            });
            
            var result = [];
            
            // 헤더 행
            var header = ['직책', '성명', '합계'];
            for (var i = 0; i < dates.length; i++) {
                var date = new Date(dates[i]);
                var month = date.getMonth() + 1;
                var day = date.getDate();
                var weekdays = ['일', '월', '화', '수', '목', '금', '토'];
                var weekday = weekdays[date.getDay()];
                header.push(month + '/' + day + '(' + weekday + ')');
            }
            result.push(header);
            
            // 데이터 행
            for (var memberIndex = 0; memberIndex < memberEntries.length; memberIndex++) {
                var name = memberEntries[memberIndex];
                var info = data[name];
                
                if (!info || !info.stats) continue;
                
                var row = [
                    info.role || '미정',
                    name,
                    info.stats.total || 0
                ];
                
                for (var dateIndex = 0; dateIndex < dates.length; dateIndex++) {
                    var date = dates[dateIndex];
                    var attendance = info.attendance || {};
                    var status = attendance[date] || 0;
                    row.push(status === 1 ? '출석' : '불참');
                }
                
                result.push(row);
            }
            
            return result;
        }
        
        // 요약 통계 데이터 생성
        function generateSummaryData(reportData) {
            var data = reportData.members || reportData;
            var memberEntries = Object.keys(data);
            memberEntries.sort(function(a, b) {
                var orderA = data[a].order || 0;
                var orderB = data[b].order || 0;
                return orderA - orderB;
            });
            
            var result = [];
            result.push(['이름', '직책', '총 출석', '수요일 출석', '조건 충족', '달성률(%)']);
            
            for (var i = 0; i < memberEntries.length; i++) {
                var name = memberEntries[i];
                var info = data[name];
                
                if (!info || !info.stats) continue;
                
                var stats = info.stats;
                var role = info.role || '미정';
                
                // 달성률 계산
                var achievementRate = 0;
                if (role !== '운영진' && stats.required_total > 0) {
                    achievementRate = Math.round((stats.total / stats.required_total) * 100);
                }
                
                result.push([
                    name,
                    role,
                    stats.total || 0,
                    stats.wednesday || 0,
                    stats.meets_requirement ? '충족' : '미충족',
                    role === '운영진' ? 'N/A' : achievementRate + '%'
                ]);
            }
            
            return result;
        }
        
        // CSV 컨텐츠 생성
        function generateCSVContent(reportData) {
            var excelData = generateExcelData(reportData);
            var csvContent = '';
            
            for (var i = 0; i < excelData.length; i++) {
                var row = excelData[i];
                var csvRow = row.map(function(cell) {
                    // CSV에서 쉼표와 따옴표 처리
                    var cellStr = String(cell);
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        cellStr = '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                }).join(',');
                
                csvContent += csvRow + '\n';
            }
            
            // UTF-8 BOM 추가 (한글 깨짐 방지)
            return '\uFEFF' + csvContent;
        }
        
        // 요약 보고서 생성
        function generateSummaryReport(reportData) {
            var data = reportData.members || reportData;
            var dates = reportData.dates || [];
            var memberEntries = Object.keys(data);
            memberEntries.sort(function(a, b) {
                var orderA = data[a].order || 0;
                var orderB = data[b].order || 0;
                return orderA - orderB;
            });
            
            var report = '';
            report += '='.repeat(60) + '\n';
            report += '               출석 관리 시스템 요약 보고서\n';
            report += '='.repeat(60) + '\n';
            report += '보고서 생성일: ' + new Date().toLocaleString('ko-KR') + '\n';
            report += '대상 기간: ' + currentYear + '년 ' + currentMonth + '월\n';
            report += '총 출석일: ' + dates.length + '일\n';
            report += '총 멤버수: ' + memberEntries.length + '명\n';
            report += '\n';
            
            // 역할별 통계
            var roleStats = {};
            var totalPass = 0;
            var totalFail = 0;
            
            for (var i = 0; i < memberEntries.length; i++) {
                var name = memberEntries[i];
                var info = data[name];
                if (!info || !info.stats) continue;
                
                var role = info.role || '미정';
                if (!roleStats[role]) {
                    roleStats[role] = { total: 0, pass: 0, fail: 0 };
                }
                
                roleStats[role].total++;
                if (info.stats.meets_requirement) {
                    roleStats[role].pass++;
                    totalPass++;
                } else {
                    roleStats[role].fail++;
                    totalFail++;
                }
            }
            
            report += '[ 역할별 통계 ]\n';
            report += '-'.repeat(40) + '\n';
            for (var role in roleStats) {
                var stat = roleStats[role];
                var passRate = stat.total > 0 ? Math.round((stat.pass / stat.total) * 100) : 0;
                report += role + ': ' + stat.total + '명 (충족: ' + stat.pass + '명, 미충족: ' + stat.fail + '명, 충족률: ' + passRate + '%)\n';
            }
            report += '\n';
            
            report += '[ 전체 요약 ]\n';
            report += '-'.repeat(40) + '\n';
            var overallPassRate = (totalPass + totalFail) > 0 ? Math.round((totalPass / (totalPass + totalFail)) * 100) : 0;
            report += '조건 충족: ' + totalPass + '명\n';
            report += '조건 미충족: ' + totalFail + '명\n';
            report += '전체 충족률: ' + overallPassRate + '%\n';
            report += '\n';
            
            report += '[ 개별 멤버 상세 ]\n';
            report += '-'.repeat(60) + '\n';
            
            for (var i = 0; i < memberEntries.length; i++) {
                var name = memberEntries[i];
                var info = data[name];
                if (!info || !info.stats) continue;
                
                var stats = info.stats;
                var role = info.role || '미정';
                
                report += (i + 1) + '. ' + name + ' (' + role + ')\n';
                report += '   총 출석: ' + (stats.total || 0) + '회';
                if (role === '페이서 강남') {
                    report += ' (수요일: ' + (stats.wednesday || 0) + '회)';
                }
                report += '\n';
                
                if (role !== '운영진') {
                    report += '   필요 출석: ' + (stats.required_total || 0) + '회';
                    if (stats.required_wednesday > 0) {
                        report += ' (수요일: ' + stats.required_wednesday + '회)';
                    }
                    report += '\n';
                    report += '   조건 충족: ' + (stats.meets_requirement ? '✓ 충족' : '✗ 미충족') + '\n';
                }
                report += '\n';
            }
            
            report += '[ 출석 조건 안내 ]\n';
            report += '-'.repeat(40) + '\n';
            report += '• 운영진: 출석 조건 없음\n';
            report += '• 페이서: 월 3회 이상 출석\n';
            report += '• 페이서 강남: 월 3회 이상 출석 (그 중 수요일 2회 이상)\n';
            report += '• 포토: 월 1회 이상 출석\n';
            report += '\n';
            
            report += '='.repeat(60) + '\n';
            report += '                    보고서 끝\n';
            report += '='.repeat(60) + '\n';
            
            return report;
        }
        
        // 파일 다운로드 함수
        function downloadFile(content, fileName, mimeType) {
            var blob = new Blob([content], { type: mimeType });
            var url = window.URL.createObjectURL(blob);
            
            var a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.style.display = 'none';
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            window.URL.revokeObjectURL(url);
        }

        // =============================================================================
        // IMPORT 기능들
        // =============================================================================

        // 파일에서 데이터 가져오기
        function importFromFile() {
            var fileInput = document.getElementById('importFileInput');
            var file = fileInput.files[0];
            var messageDiv = document.getElementById('importMessage');

            if (!file) {
                showMessage('파일을 선택해주세요.', 'error', messageDiv);
                return;
            }

            // 지원하는 파일 형식 확인
            var fileName = file.name.toLowerCase();
            if (fileName.endsWith('.json')) {
                importFileType = 'json';
                readJSONFile(file);
            } else if (fileName.endsWith('.xlsx')) {
                importFileType = 'excel';
                readExcelFile(file);
            } else if (fileName.endsWith('.csv')) {
                importFileType = 'csv';
                readCSVFile(file);
            } else {
                showMessage('지원하지 않는 파일 형식입니다. JSON, Excel(.xlsx), CSV 파일만 지원합니다.', 'error', messageDiv);
                return;
            }
        }

        // JSON 파일 읽기
        function readJSONFile(file) {
            var reader = new FileReader();
            var messageDiv = document.getElementById('importMessage');

            reader.onload = function(e) {
                try {
                    var jsonData = JSON.parse(e.target.result);

                    // JSON 데이터 형식 검증
                    if (validateJSONImportData(jsonData)) {
                        importData = jsonData;
                        showImportPreview();
                        showMessage('파일을 성공적으로 읽었습니다. 미리보기를 확인한 후 가져오기를 진행하세요.', 'success', messageDiv);
                    } else {
                        showMessage('올바르지 않은 JSON 데이터 형식입니다.', 'error', messageDiv);
                    }
                } catch (error) {
                    showMessage('JSON 파일 읽기 오류: ' + error.message, 'error', messageDiv);
                }
            };

            reader.onerror = function() {
                showMessage('파일 읽기 중 오류가 발생했습니다.', 'error', messageDiv);
            };

            reader.readAsText(file);
        }

        // Excel 파일 읽기
        function readExcelFile(file) {
            var reader = new FileReader();
            var messageDiv = document.getElementById('importMessage');

            reader.onload = function(e) {
                try {
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, { type: 'array' });

                    // 첫 번째 시트에서 데이터 추출
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // Excel 데이터를 JSON 형식으로 변환
                    var convertedData = convertExcelToImportData(jsonData);

                    if (convertedData) {
                        importData = convertedData;
                        showImportPreview();
                        showMessage('Excel 파일을 성공적으로 읽었습니다. 미리보기를 확인한 후 가져오기를 진행하세요.', 'success', messageDiv);
                    } else {
                        showMessage('Excel 파일 형식이 올바르지 않습니다.', 'error', messageDiv);
                    }
                } catch (error) {
                    showMessage('Excel 파일 읽기 오류: ' + error.message, 'error', messageDiv);
                }
            };

            reader.onerror = function() {
                showMessage('파일 읽기 중 오류가 발생했습니다.', 'error', messageDiv);
            };

            reader.readAsArrayBuffer(file);
        }

        // CSV 파일 읽기
        function readCSVFile(file) {
            var reader = new FileReader();
            var messageDiv = document.getElementById('importMessage');

            reader.onload = function(e) {
                try {
                    var csvText = e.target.result;
                    var lines = csvText.split('\n');
                    var csvData = [];

                    for (var i = 0; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            csvData.push(parseCSVLine(lines[i]));
                        }
                    }

                    // CSV 데이터를 JSON 형식으로 변환
                    var convertedData = convertExcelToImportData(csvData); // Excel과 동일한 형식

                    if (convertedData) {
                        importData = convertedData;
                        showImportPreview();
                        showMessage('CSV 파일을 성공적으로 읽었습니다. 미리보기를 확인한 후 가져오기를 진행하세요.', 'success', messageDiv);
                    } else {
                        showMessage('CSV 파일 형식이 올바르지 않습니다.', 'error', messageDiv);
                    }
                } catch (error) {
                    showMessage('CSV 파일 읽기 오류: ' + error.message, 'error', messageDiv);
                }
            };

            reader.onerror = function() {
                showMessage('파일 읽기 중 오류가 발생했습니다.', 'error', messageDiv);
            };

            reader.readAsText(file, 'UTF-8');
        }

        // CSV 라인 파싱
        function parseCSVLine(line) {
            var result = [];
            var current = '';
            var inQuotes = false;

            for (var i = 0; i < line.length; i++) {
                var char = line[i];

                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }

            result.push(current.trim());
            return result;
        }

        // JSON 데이터 형식 검증
        function validateJSONImportData(data) {
            // 내보내기 형식인지 확인
            if (data.members && data.dates && data.year && data.month) {
                return true;
            }

            // 백업 형식인지 확인
            if (data.data && typeof data.data === 'object') {
                return true;
            }

            return false;
        }

        // Excel/CSV 데이터를 import 형식으로 변환
        function convertExcelToImportData(data) {
            if (data.length < 2) return null;

            var headers = data[0];
            var memberRows = data.slice(1);

            // 헤더에서 날짜 추출
            var dates = [];
            var dateStartIndex = 3; // 직책, 성명, 합계 다음부터

            for (var i = dateStartIndex; i < headers.length; i++) {
                var header = headers[i];
                if (header && typeof header === 'string') {
                    // 날짜 형식 파싱 (예: "6/1(월)", "2024-06-01" 등)
                    var dateStr = parseDateFromHeader(header);
                    if (dateStr) {
                        dates.push(dateStr);
                    }
                }
            }

            if (dates.length === 0) return null;

            // 멤버 데이터 구성
            var members = {};
            var order = 0;

            for (var i = 0; i < memberRows.length; i++) {
                var row = memberRows[i];
                if (row.length < 3) continue;

                var role = row[0];
                var name = row[1];

                if (!name || !role) continue;

                var attendance = {};
                for (var j = 0; j < dates.length; j++) {
                    var cellValue = row[dateStartIndex + j];
                    var status = 0;

                    if (cellValue === '출석' || cellValue === '1' || cellValue === 1) {
                        status = 1;
                    }

                    attendance[dates[j]] = status;
                }

                members[name] = {
                    role: role,
                    order: order++,
                    attendance: attendance,
                    stats: calculateStatsFromAttendance(attendance, role, dates)
                };
            }

            return {
                year: currentYear,
                month: currentMonth,
                members: members,
                dates: dates,
                exportDate: new Date().toISOString()
            };
        }

        // 헤더에서 날짜 파싱
        function parseDateFromHeader(header) {
            // "6/1(월)" 형식
            var match1 = header.match(/(\d+)\/(\d+)/);
            if (match1) {
                var month = parseInt(match1[1]);
                var day = parseInt(match1[2]);
                return currentYear + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
            }

            // "2024-06-01" 형식
            var match2 = header.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (match2) {
                return header;
            }

            return null;
        }

        // 출석 데이터에서 통계 계산
        function calculateStatsFromAttendance(attendance, role, dates) {
            var total = 0;
            var wednesday = 0;

            for (var i = 0; i < dates.length; i++) {
                var date = dates[i];
                if (attendance[date] === 1) {
                    total++;

                    var dateObj = new Date(date);
                    if (dateObj.getDay() === 3) {
                        wednesday++;
                    }
                }
            }

            // 조건 충족 여부 계산
            var requirements = {
                '운영진': { total: 0, wednesday: 0 },
                '페이서': { total: 3, wednesday: 0 },
                '페이서 강남': { total: 3, wednesday: 2 },
                '포토': { total: 1, wednesday: 0 }
            };

            var req = requirements[role] || { total: 0, wednesday: 0 };
            var meetsRequirement = role === '운영진' || 
                                 (total >= req.total && wednesday >= req.wednesday);

            return {
                total: total,
                wednesday: wednesday,
                meets_requirement: meetsRequirement,
                required_total: req.total,
                required_wednesday: req.wednesday
            };
        }

        // 가져올 데이터 미리보기 표시
        function showImportPreview() {
            var previewDiv = document.getElementById('importPreview');
            var previewContent = document.getElementById('previewContent');

            if (!importData) return;

            var html = '';
            html += '<p><strong>🗓️ 대상 기간:</strong> ' + importData.year + '년 ' + importData.month + '월</p>';
            html += '<p><strong>👥 멤버 수:</strong> ' + Object.keys(importData.members || {}).length + '명</p>';
            html += '<p><strong>📅 출석일 수:</strong> ' + (importData.dates || []).length + '일</p>';

            html += '<div style="margin-top: 15px;"><strong>👤 멤버 목록:</strong></div>';
            html += '<div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 5px; border-radius: 4px;">';

            var memberEntries = Object.keys(importData.members || {});
            memberEntries.sort(function(a, b) {
                var orderA = importData.members[a].order || 0;
                var orderB = importData.members[b].order || 0;
                return orderA - orderB;
            });

            for (var i = 0; i < memberEntries.length; i++) {
                var name = memberEntries[i];
                var member = importData.members[name];
                var stats = member.stats || {};

                html += '<div style="padding: 5px; border-bottom: 1px solid #eee;">';
                html += '<strong>' + name + '</strong> (' + (member.role || '미정') + ') - ';
                html += '출석: ' + (stats.total || 0) + '회';
                if (member.role === '페이서 강남') {
                    html += ' (수요일: ' + (stats.wednesday || 0) + '회)';
                }
                html += ' - ' + (stats.meets_requirement ? '✅ 충족' : '❌ 미충족');
                html += '</div>';
            }

            html += '</div>';

            html += '<div style="margin-top: 15px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">';
            html += '<strong>⚠️ 주의사항:</strong><br>';
            html += '• 현재 ' + currentYear + '년 ' + currentMonth + '월의 모든 데이터가 삭제됩니다<br>';
            html += '• 가져오기 전에 현재 데이터를 백업하는 것을 권장합니다<br>';
            html += '• 이 작업은 되돌릴 수 없습니다';
            html += '</div>';

            previewContent.innerHTML = html;
            previewDiv.style.display = 'block';

            // 버튼들 표시
            document.getElementById('previewBtn').style.display = 'inline-block';
            document.getElementById('confirmBtn').style.display = 'inline-block';
            document.getElementById('cancelBtn').style.display = 'inline-block';
        }

        // 미리보기 확장
        function previewImportData() {
            // 상세 미리보기 모달이나 페이지를 열 수 있음
            alert('상세 미리보기 기능은 현재 위의 요약 정보를 참고해주세요.');
        }

        // 가져오기 확정
        function confirmImport() {
            if (!importData) {
                showMessage('가져올 데이터가 없습니다.', 'error', document.getElementById('importMessage'));
                return;
            }

            if (!confirm('정말로 현재 월(' + currentYear + '년 ' + currentMonth + '월)의 모든 데이터를 덮어쓰시겠습니까?\n\n이 작업은 되돌릴 수 없습니다!')) {
                return;
            }

            var messageDiv = document.getElementById('importMessage');
            showMessage('데이터를 가져오는 중입니다...', 'info', messageDiv);

            // 서버에 데이터 전송
            fetch('/api/import_month_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth,
                    data: importData
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(result) {
                if (result.success) {
                    showMessage('데이터를 성공적으로 가져왔습니다!', 'success', messageDiv);
                    resetImportUI();

                    // 화면 새로고침
                    setTimeout(function() {
                        loadCurrentMonth();
                    }, 1000);
                } else {
                    showMessage('데이터 가져오기에 실패했습니다: ' + (result.error || '알 수 없는 오류'), 'error', messageDiv);
                }
            })
            .catch(function(error) {
                showMessage('네트워크 오류가 발생했습니다: ' + error, 'error', messageDiv);
            });
        }

        // 가져오기 취소
        function cancelImport() {
            resetImportUI();
            showMessage('가져오기를 취소했습니다.', 'info', document.getElementById('importMessage'));
        }

        // Import UI 초기화
        function resetImportUI() {
            importData = null;
            importFileType = null;
            document.getElementById('importFileInput').value = '';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('previewBtn').style.display = 'none';
            document.getElementById('confirmBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
        }

        // 현재 월 데이터 로드
        function loadCurrentMonth() {
            currentYear = parseInt(document.getElementById('year').value);
            currentMonth = parseInt(document.getElementById('month').value);

            // 현재 월 표시 업데이트
            updateCurrentMonthDisplay();

            loadMemberManagement();
            loadAttendanceTable();
        }

        // 현재 월 표시 업데이트
        function updateCurrentMonthDisplay() {
            var displayElement = document.getElementById('currentMonthDisplay');
            if (displayElement) {
                displayElement.textContent = currentYear + '년 ' + currentMonth + '월';
            }
        }

        // 전월 멤버 복사
        function copyFromPreviousMonth() {
            var messageDiv = document.getElementById('monthMessage');

            fetch('/api/copy_previous_month', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    showMessage('전월 멤버를 성공적으로 복사했습니다!', 'success', messageDiv);
                    // 전월 멤버 복사 후 첫 번째 멤버 선택
                    selectedMemberIndex = 0;
                    loadCurrentMonthWithSync();
                } else {
                    showMessage('전월 데이터가 없거나 복사에 실패했습니다.', 'error', messageDiv);
                }
            })
            .catch(function(error) {
                showMessage('네트워크 오류가 발생했습니다: ' + error, 'error', messageDiv);
            });
        }

        // 멤버 추가
        function addMember() {
            var name = document.getElementById('memberName').value.trim();
            var role = document.getElementById('memberRole').value;
            var messageDiv = document.getElementById('memberMessage');

            if (!name) {
                showMessage('이름을 입력해주세요.', 'error', messageDiv);
                return;
            }

            fetch('/api/add_member', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth,
                    name: name,
                    role: role
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    showMessage('멤버가 성공적으로 추가되었습니다!', 'success', messageDiv);
                    document.getElementById('memberName').value = '';

                    // 멤버 추가 후 전체 업데이트 (순서 유지)
                    loadCurrentMonthWithSync();
                } else {
                    showMessage('멤버 추가에 실패했습니다: ' + (data.error || '알 수 없는 오류'), 'error', messageDiv);
                }
            })
            .catch(function(error) {
                showMessage('네트워크 오류가 발생했습니다: ' + error, 'error', messageDiv);
            });
        }<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>페이서 출석 관리 시스템</title>
    <!-- SortableJS 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- SheetJS 라이브러리 (Excel 내보내기용) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        /* 로그인 화면 스타일 */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            min-width: 350px;
            max-width: 400px;
            width: 90%;
        }
        
        .login-container h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .login-container .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .login-form input {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .login-form input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .login-form input.error {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .login-form button {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .login-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .login-form button:active {
            transform: translateY(0);
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            border-left: 4px solid #c62828;
        }
        
        .security-note {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            font-size: 0.85em;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }
        
        .forgot-password {
            margin-top: 15px;
            color: #666;
            font-size: 0.9em;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .forgot-password:hover {
            color: #667eea;
        }
        
        /* 메인 컨텐츠는 숨김 */
        .main-content {
            display: none;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .logout-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }
        
        .logout-button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        input, select, button {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }
        
        /* Export 버튼 스타일 */
        .export-section {
            border-left-color: #17a2b8;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .export-buttons button {
            min-width: 120px;
            font-size: 13px;
        }
        
        /* 뷰 전환 버튼 - PC와 모바일 모두 표시 */
        .view-toggle {
            display: block; /* 항상 표시 */
            text-align: center;
            margin-bottom: 20px;
        }
        
        .view-toggle button {
            margin: 0 5px;
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .view-toggle button.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        .view-toggle button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }
        
        /* 테이블 스타일 */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .attendance-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 11px;
            min-width: 60px;
        }
        
        .attendance-table td {
            padding: 10px 6px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            min-width: 60px;
        }
        
        .attendance-cell {
            cursor: pointer;
            user-select: none;
            font-weight: 600;
            transition: all 0.2s ease;
            border-radius: 4px;
            margin: 2px;
            padding: 8px;
            min-width: 40px;
            min-height: 40px;
            text-align: center;
            vertical-align: middle;
        }
        
        .attendance-cell:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .present {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }
        
        .absent {
            background: white;
            color: #333;
            border: 2px solid #dee2e6;
        }
        
        .pass {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        
        .fail {
            background-color: #ffebee;
            color: #c62828;
        }
        
        /* 멤버 선택 드롭다운 */
        .member-selector {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .member-selector select {
            min-width: 200px;
            font-size: 16px;
            padding: 12px 16px;
        }
        
        .member-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }
        
        /* 카드 뷰 내비게이션 */
        .card-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .nav-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            min-width: 80px;
        }
        
        .nav-button:hover {
            background: #5a67d8;
        }
        
        .nav-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .member-indicator {
            font-weight: bold;
            color: #333;
            text-align: center;
            flex: 1;
            margin: 0 15px;
        }
        
        /* 단일 카드 표시 */
        .single-card-container {
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .no-member-selected {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #ddd;
        }
        
        .no-member-selected h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .mobile-view {
            display: none;
        }
        
        .member-card-view {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        
        .member-card-view.fail {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        
        .member-card-view.pass {
            border-left-color: #28a745;
            background: #f8fff8;
        }
        
        .member-header-mobile {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .member-name-mobile {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .member-role-mobile {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .member-stats-mobile {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }
        
        .attendance-grid-mobile {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        
        .attendance-item-mobile {
            text-align: center;
            padding: 10px 5px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .attendance-item-mobile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .attendance-item-mobile.present {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border-color: #4caf50;
        }
        
        .attendance-item-mobile.absent {
            background: white;
            color: #333;
            border-color: #dee2e6;
        }
        
        .date-label-mobile {
            font-size: 0.7em;
            line-height: 1.2;
            margin-bottom: 5px;
        }
        
        .attendance-value-mobile {
            font-size: 1.1em;
            font-weight: bold;
        }
        
        /* 멤버 관리 */
        .member-management {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .member-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 80px;
            cursor: move;
            position: relative;
        }
        
        .member-info {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: 40px;
        }
        
        .member-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            min-width: 100px;
        }
        
        .member-role {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .member-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .member-actions button {
            padding: 8px 12px;
            font-size: 12px;
        }
        
        .drag-handle {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: move;
            color: #6c757d;
            font-size: 18px;
            padding: 5px;
        }
        
        .sortable-ghost {
            opacity: 0.3;
            background: #f8f9fa;
        }
        
        .sortable-drag {
            opacity: 0.6;
            transform: rotate(5deg);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        /* 모달 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        /* PC 버전 카드뷰 최적화 */
        @media (min-width: 769px) {
            .desktop-view {
                display: block; /* PC에서 기본값은 테이블 뷰 */
            }
            
            .mobile-view {
                display: none; /* PC에서 기본값은 카드뷰 숨김 */
            }
            
            /* PC에서 카드뷰가 선택된 경우 */
            .mobile-view.active {
                display: block;
            }
            
            .desktop-view.inactive {
                display: none;
            }
            
            /* PC 카드뷰 스타일 조정 */
            .member-card-view {
                max-width: 800px;
                margin: 0 auto 20px auto;
            }
            
            .single-card-container {
                min-height: 300px;
            }
            
            /* PC 네비게이션 버튼 크기 조정 */
            .card-navigation {
                max-width: 600px;
                margin: 0 auto 20px auto;
            }
            
            .nav-button {
                padding: 12px 20px;
                font-size: 16px;
                min-width: 100px;
            }
            
            /* PC 멤버 선택 드롭다운 */
            .member-selector {
                max-width: 400px;
                margin: 0 auto 20px auto;
            }
            
            .member-selector select {
                min-width: 250px;
                font-size: 16px;
            }
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .content {
                padding: 15px;
            }
            
            .section {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .controls > * {
                width: 100%;
            }
            
            input, select, button {
                padding: 12px;
                font-size: 16px;
            }
            
            /* 모바일에서는 기본적으로 카드 뷰 */
            .desktop-view {
                display: none;
            }
            
            .mobile-view {
                display: block;
            }
            
            .member-card {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
                padding: 15px;
            }
            
            .member-info {
                margin-left: 0;
                flex-direction: column;
                gap: 10px;
                align-items: center;
                text-align: center;
            }
            
            .member-actions {
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .drag-handle {
                position: static;
                transform: none;
                align-self: center;
                margin-bottom: 10px;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 20px;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .export-buttons button {
                width: 100%;
            }
            
            .login-container {
                padding: 30px 20px;
                min-width: 300px;
            }
            
            .logout-button {
                position: static;
                margin-bottom: 10px;
                display: block;
                width: fit-content;
                margin-left: auto;
                margin-right: auto;
            }
        }
    </style>
</head>
<body>
    <!-- 로그인 오버레이 -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-container">
            <h1>🔐 시스템 접근</h1>
            <p class="subtitle">페이서 출석 관리 시스템</p>
            
            <form class="login-form" onsubmit="return handleLogin(event)">
                <input 
                    type="password" 
                    id="passwordInput" 
                    placeholder="암호를 입력하세요" 
                    required
                    autocomplete="current-password"
                >
                <button type="submit">🚀 접속하기</button>
            </form>
            
            <div id="loginError" class="error-message" style="display: none;"></div>
            
            <div class="forgot-password" onclick="showPasswordHint()">
                💡 암호를 잊으셨나요?
            </div>
            
            <div class="security-note">
                🛡️ <strong>보안 안내</strong><br>
                이 시스템은 출석 관리를 위한 보호된 영역입니다.<br>
                인증된 사용자만 접근할 수 있습니다.
            </div>
        </div>
    </div>

    <!-- 메인 컨텐츠 -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <div class="header">
                <button class="logout-button" onclick="logout()">🚪 로그아웃</button>
                <h1>📊페이서 출석 관리 시스템</h1>
                <p>피지크 페이서 출석 관리자 페이지</p>
            </div>
            
            <div class="content">
                <!-- 월 선택 -->
                <div class="section">
                    <h2>📅 월 선택 및 관리</h2>
                    <div class="controls">
                        <label>년도:</label>
                        <input type="number" id="year" value="2024" min="2020" max="2030">
                        <label>월:</label>
                        <select id="month">
                            <option value="1">1월</option>
                            <option value="2">2월</option>
                            <option value="3">3월</option>
                            <option value="4">4월</option>
                            <option value="5">5월</option>
                            <option value="6" selected>6월</option>
                            <option value="7">7월</option>
                            <option value="8">8월</option>
                            <option value="9">9월</option>
                            <option value="10">10월</option>
                            <option value="11">11월</option>
                            <option value="12">12월</option>
                        </select>
                        <button onclick="loadCurrentMonth()">조회</button>
                        <button class="btn-success" onclick="copyFromPreviousMonth()">전월 멤버 복사</button>
                    </div>
                    <div id="monthMessage"></div>
                </div>
                
                <!-- 데이터 Export -->
                <div class="section export-section">
                    <h2>📁 데이터 내보내기</h2>
                    <p>현재 선택된 월의 출석 데이터를 다양한 형식으로 내보낼 수 있습니다.</p>
                    <div class="export-buttons">
                        <button class="btn-info" onclick="exportToExcel()">📊 Excel 파일로 내보내기</button>
                        <button class="btn-info" onclick="exportToCSV()">📋 CSV 파일로 내보내기</button>
                        <button class="btn-info" onclick="exportToJSON()">💾 JSON 파일로 내보내기</button>
                        <button class="btn-info" onclick="exportSummaryReport()">📈 요약 보고서 내보내기</button>
                    </div>
                    <div id="exportMessage"></div>
                </div>
                
                <!-- 데이터 Import -->
                <div class="section export-section">
                    <h2>📥 데이터 가져오기</h2>
                    <p><strong>⚠️ 주의:</strong> 가져온 데이터는 현재 선택된 월(<span id="currentMonthDisplay"></span>)의 모든 데이터를 덮어씁니다!</p>
                    <div class="controls">
                        <input type="file" id="importFileInput" accept=".json,.xlsx,.csv" style="margin-bottom: 10px;">
                        <div class="export-buttons">
                            <button class="btn-warning" onclick="importFromFile()">📁 파일에서 가져오기</button>
                            <button class="btn-secondary" onclick="previewImportData()" id="previewBtn" style="display: none;">👁️ 미리보기</button>
                            <button class="btn-success" onclick="confirmImport()" id="confirmBtn" style="display: none;">✅ 가져오기 확정</button>
                            <button class="btn-danger" onclick="cancelImport()" id="cancelBtn" style="display: none;">❌ 취소</button>
                        </div>
                    </div>
                    <div id="importMessage"></div>
                    <div id="importPreview" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                        <h4>📋 가져올 데이터 미리보기</h4>
                        <div id="previewContent"></div>
                    </div>
                </div>
                
                <!-- 멤버 추가 -->
                <div class="section">
                    <h2>👥 멤버 추가</h2>
                    <div class="controls">
                        <input type="text" id="memberName" placeholder="이름을 입력하세요">
                        <select id="memberRole">
                            <option value="운영진">운영진</option>
                            <option value="페이서">페이서</option>
                            <option value="페이서 강남">페이서 강남</option>
                            <option value="포토">포토</option>
                        </select>
                        <button onclick="addMember()">멤버 추가</button>
                    </div>
                    <div id="memberMessage"></div>
                </div>
                
                <!-- 출석 현황 -->
                <div class="section">
                    <h2>📊 출석 현황</h2>
                    <div id="attendanceTable">
                        <div class="loading">출석 데이터를 불러오는 중입니다...</div>
                    </div>
                </div>
                
                <!-- 멤버 관리 -->
                <div class="section">
                    <h2>👤 멤버 관리</h2>
                    <div id="memberManagement">
                        <div class="loading">멤버 목록을 불러오는 중입니다...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 역할 변경 모달 -->
    <div id="roleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>역할 변경</h3>
                <span class="close" onclick="closeRoleModal()">&times;</span>
            </div>
            <div>
                <p id="roleModalMemberName"></p>
                <select id="newRole">
                    <option value="운영진">운영진</option>
                    <option value="페이서">페이서</option>
                    <option value="페이서 강남">페이서 강남</option>
                    <option value="포토">포토</option>
                </select>
                <div style="margin-top: 20px;">
                    <button onclick="updateMemberRole()">변경</button>
                    <button class="btn-secondary" onclick="closeRoleModal()">취소</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================================================
        // 보안 및 인증 관련 코드
        // =============================================================================
        
        // 설정 가능한 암호들
        const VALID_PASSWORDS = [
            'pacer2024',        // 기본 암호
            'physique2024',     // 대체 암호
            'attendance2024'    // 관리자 암호
        ];
        
        const PASSWORD_HINTS = {
            'pacer2024': '페이서 + 올해 년도',
            'physique2024': '피지크 + 올해 년도',
            'attendance2024': '출석 영어 + 올해 년도'
        };
        
        // 세션 타임아웃 (밀리초) - 1시간
        const SESSION_TIMEOUT = 60 * 60 * 1000;
        
        // 로그인 시도 제한
        let loginAttempts = 0;
        const MAX_LOGIN_ATTEMPTS = 5;
        const LOCKOUT_TIME = 15 * 60 * 1000; // 15분
        
        // 세션 관리
        let sessionTimer = null;
        
        // 로그인 처리
        function handleLogin(event) {
            event.preventDefault();
            
            const lockoutTime = localStorage.getItem('attendance_lockout');
            if (lockoutTime && Date.now() < parseInt(lockoutTime)) {
                showLockoutMessage();
                return false;
            }
            
            const passwordInput = document.getElementById('passwordInput');
            const password = passwordInput.value.trim();
            
            if (!password) {
                showLoginError('❌ 암호를 입력해주세요.');
                return false;
            }
            
            // 암호 확인
            if (VALID_PASSWORDS.includes(password)) {
                // 로그인 성공
                loginSuccess();
            } else {
                // 로그인 실패
                loginAttempts++;
                
                if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
                    // 계정 잠금
                    localStorage.setItem('attendance_lockout', (Date.now() + LOCKOUT_TIME).toString());
                    showLockoutMessage();
                } else {
                    const remainingAttempts = MAX_LOGIN_ATTEMPTS - loginAttempts;
                    showLoginError(`❌ 잘못된 암호입니다. (${remainingAttempts}번의 시도가 남았습니다)`);
                    
                    // 입력 필드 흔들림 효과
                    passwordInput.style.animation = 'shake 0.5s ease-in-out';
                    setTimeout(() => {
                        passwordInput.style.animation = '';
                    }, 500);
                }
                
                // 입력 필드 초기화
                passwordInput.value = '';
                passwordInput.focus();
            }
            
            return false;
        }
        
        // 로그인 성공 처리
        function loginSuccess() {
            // 세션 정보 저장
            sessionStorage.setItem('attendance_authenticated', 'true');
            sessionStorage.setItem('attendance_login_time', Date.now().toString());
            
            // 로그인 시도 횟수 초기화
            loginAttempts = 0;
            localStorage.removeItem('attendance_lockout');
            
            // 성공 메시지 표시
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.innerHTML = `
                    <div style="background: #e8f5e8; color: #2e7d32; border-left-color: #4caf50;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2em;">✅</span>
                            <span>로그인 성공! 시스템에 접속합니다...</span>
                        </div>
                    </div>
                `;
                errorDiv.style.display = 'block';
            }
            
            // 0.8초 후 메인 컨텐츠 표시
            setTimeout(() => {
                showMainContent();
                startSessionTimer();
                initializeMainContent();
            }, 800);
        }
        
        // 로그아웃
        function logout(message = null) {
            // 세션 정보 삭제
            sessionStorage.removeItem('attendance_authenticated');
            sessionStorage.removeItem('attendance_login_time');
            
            // 세션 타이머 정지
            if (sessionTimer) {
                clearTimeout(sessionTimer);
                sessionTimer = null;
            }
            
            // 로그인 화면 표시
            showLoginScreen();
            
            // 메시지 표시
            if (message) {
                setTimeout(() => {
                    showLoginError(message);
                }, 100);
            }
        }
        
        // 로그인 화면 표시
        function showLoginScreen() {
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            
            // 입력 필드 초기화 및 포커스
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.value = '';
                setTimeout(() => passwordInput.focus(), 100);
            }
            
            // 에러 메시지 숨기기
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }
        
        // 메인 컨텐츠 표시
        function showMainContent() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }
        
        // 로그인 에러 메시지 표시
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            const passwordInput = document.getElementById('passwordInput');
            
            if (errorDiv) {
                errorDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.2em;">🚨</span>
                        <span>${message}</span>
                    </div>
                `;
                errorDiv.style.display = 'block';
                
                // 입력 필드에 에러 스타일 추가
                if (passwordInput) {
                    passwordInput.classList.add('error');
                    setTimeout(() => {
                        passwordInput.classList.remove('error');
                    }, 3000);
                }
                
                // 5초 후 자동 숨김
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // 잠금 메시지 표시
        function showLockoutMessage() {
            const lockoutTime = localStorage.getItem('attendance_lockout');
            if (lockoutTime) {
                const remainingTime = Math.ceil((parseInt(lockoutTime) - Date.now()) / 1000 / 60);
                showLoginError(`🔒 보안을 위해 계정이 잠겼습니다. ${remainingTime}분 후 다시 시도해주세요.`);
            }
        }
        
        // 암호 힌트 표시
        function showPasswordHint() {
            const hints = Object.values(PASSWORD_HINTS);
            const hintMessage = `암호 힌트:\n${hints.map((hint, index) => `• ${hint}`).join('\n')}`;
            alert(hintMessage);
        }
        
        // 세션 타이머 시작
        function startSessionTimer() {
            if (sessionTimer) {
                clearTimeout(sessionTimer);
            }
            
            sessionTimer = setTimeout(() => {
                logout('보안을 위해 자동 로그아웃되었습니다.');
            }, SESSION_TIMEOUT);
        }
        
        // 사용자 활동 감지 (세션 연장)
        document.addEventListener('click', extendSession);
        document.addEventListener('keypress', extendSession);
        document.addEventListener('scroll', extendSession);
        
        function extendSession() {
            const isAuthenticated = sessionStorage.getItem('attendance_authenticated');
            if (isAuthenticated) {
                sessionStorage.setItem('attendance_login_time', Date.now().toString());
                startSessionTimer();
            }
        }
        
        // 인증 상태 확인
        function checkAuthenticationStatus() {
            const isAuthenticated = sessionStorage.getItem('attendance_authenticated');
            const loginTime = sessionStorage.getItem('attendance_login_time');
            const lockoutTime = localStorage.getItem('attendance_lockout');
            
            // 잠금 상태 확인
            if (lockoutTime && Date.now() < parseInt(lockoutTime)) {
                showLockoutMessage();
                return;
            }
            
            // 세션 타임아웃 확인
            if (isAuthenticated && loginTime) {
                const timeSinceLogin = Date.now() - parseInt(loginTime);
                if (timeSinceLogin < SESSION_TIMEOUT) {
                    // 인증된 상태 - 메인 컨텐츠 표시
                    showMainContent();
                    startSessionTimer();
                    initializeMainContent();
                } else {
                    // 세션 만료
                    logout('세션이 만료되었습니다. 다시 로그인해주세요.');
                }
            } else {
                // 미인증 상태 - 로그인 화면 표시
                showLoginScreen();
            }
        }
        
        // 메인 컨텐츠 초기화
        function initializeMainContent() {
            var currentDate = new Date();
            currentYear = currentDate.getFullYear();
            currentMonth = currentDate.getMonth() + 1;
            
            document.getElementById('year').value = currentYear;
            document.getElementById('month').value = currentMonth;
            
            // Enter 키 처리
            document.getElementById('memberName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addMember();
                }
            });
            
            // 년도/월 변경 시 자동 조회
            document.getElementById('year').addEventListener('change', loadCurrentMonth);
            document.getElementById('month').addEventListener('change', loadCurrentMonth);
            
            // 초기 데이터 로드
            loadCurrentMonth();
            updateCurrentMonthDisplay();
            
            // 파일 입력 변경 감지
            document.getElementById('importFileInput').addEventListener('change', function(e) {
                resetImportUI();
            });
        }
        
        // =============================================================================
        // 기존 시스템 코드 (원본 그대로 유지)
        // =============================================================================
        
        // 전역 변수
        var currentYear = 2024;
        var currentMonth = 6;
        var currentMembers = {};
        var editingMember = null;
        var currentView = 'auto'; // 자동 감지 (모바일: card, PC: table)
        var selectedMemberIndex = 0; // 현재 선택된 멤버 인덱스
        var memberList = []; // 멤버 리스트 (정렬된)
        var userSelectedView = null; // 사용자가 직접 선택한 뷰 (null이면 기본값 사용)
        var currentReportData = null; // 현재 보고서 데이터 (export용)
        var importData = null; // 가져올 데이터 임시 저장
        var importFileType = null; // 가져올 파일 타입
        
        // 현재 환경이 모바일인지 확인
        function isMobile() {
            return window.innerWidth <= 768;
        }
        
        // 기본 뷰 결정 (모바일: card, PC: table)
        function getDefaultView() {
            return isMobile() ? 'card' : 'table';
        }
        
        // 현재 사용해야 할 뷰 결정
        function getCurrentView() {
            // 사용자가 직접 선택한 뷰가 있으면 그것 사용
            if (userSelectedView) {
                return userSelectedView;
            }
            // 없으면 환경에 맞는 기본값 사용
            return getDefaultView();
        }

        // Excel 파일로 내보내기
        function exportToExcel() {
            if (!currentReportData) {
                showMessage('먼저 출석 데이터를 조회해주세요.', 'error', document.getElementById('exportMessage'));
                return;
            }
            
            try {
                var wb = XLSX.utils.book_new();
                
                // 출석 현황 시트
                var wsData = generateExcelData(currentReportData);
                var ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // 열 너비 설정
                var colWidths = [
                    { wch: 12 }, // 직책
                    { wch: 15 }, // 성명
                    { wch: 8 },  // 합계
                ];
                
                var dates = currentReportData.dates || [];
                for (var i = 0; i < dates.length; i++) {
                    colWidths.push({ wch: 10 });
                }
                
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, "출석현황");
                
                // 요약 통계 시트
                var summaryData = generateSummaryData(currentReportData);
                var summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                summaryWs['!cols'] = [
                    { wch: 15 }, // 이름
                    { wch: 12 }, // 직책
                    { wch: 10 }, // 총 출석
                    { wch: 12 }, // 수요일 출석
                    { wch: 10 }, // 조건 충족
                    { wch: 12 }  // 달성률
                ];
                
                XLSX.utils.book_append_sheet(wb, summaryWs, "요약통계");
                
                // 파일명 생성
                var fileName = currentYear + '년_' + currentMonth + '월_출석현황.xlsx';
                
                // 파일 다운로드
                XLSX.writeFile(wb, fileName);
                
                showMessage('Excel 파일이 성공적으로 다운로드되었습니다!', 'success', document.getElementById('exportMessage'));
            } catch (error) {
                showMessage('Excel 파일 생성 중 오류가 발생했습니다: ' + error.message, 'error', document.getElementById('exportMessage'));
                console.error('Excel export error:', error);
            }
        }
        
        // CSV 파일로 내보내기
        function exportToCSV() {
            if (!currentReportData) {
                showMessage('먼저 출석 데이터를 조회해주세요.', 'error', document.getElementById('exportMessage'));
                return;
            }
            
            try {
                var csvContent = generateCSVContent(currentReportData);
                var fileName = currentYear + '년_' + currentMonth + '월_출석현황.csv';
                
                downloadFile(csvContent, fileName, 'text/csv;charset=utf-8;');
                
                showMessage('CSV 파일이 성공적으로 다운로드되었습니다!', 'success', document.getElementById('exportMessage'));
            } catch (error) {
                showMessage('CSV 파일 생성 중 오류가 발생했습니다: ' + error.message, 'error', document.getElementById('exportMessage'));
                console.error('CSV export error:', error);
            }
        }
        
        // JSON 파일로 내보내기
        function exportToJSON() {
            if (!currentReportData) {
                showMessage('먼저 출석 데이터를 조회해주세요.', 'error', document.getElementById('exportMessage'));
                return;
            }
            
            try {
                var jsonData = {
                    exportDate: new Date().toISOString(),
                    year: currentYear,
                    month: currentMonth,
                    data: currentReportData
                };
                
                var jsonContent = JSON.stringify(jsonData, null, 2);
                var fileName = currentYear + '년_' + currentMonth + '월_출석데이터.json';
                
                downloadFile(jsonContent, fileName, 'application/json;charset=utf-8;');
                
                showMessage('JSON 파일이 성공적으로 다운로드되었습니다!', 'success', document.getElementById('exportMessage'));
            } catch (error) {
                showMessage('JSON 파일 생성 중 오류가 발생했습니다: ' + error.message, 'error', document.getElementById('exportMessage'));
                console.error('JSON export error:', error);
            }
        }
        
        // 요약 보고서 내보내기
        function exportSummaryReport() {
            if (!currentReportData) {
                showMessage('먼저 출석 데이터를 조회해주세요.', 'error', document.getElementById('exportMessage'));
                return;
            }
            
            try {
                var reportContent = generateSummaryReport(currentReportData);
                var fileName = currentYear + '년_' + currentMonth + '월_출석요약보고서.txt';
                
                downloadFile(reportContent, fileName, 'text/plain;charset=utf-8;');
                
                showMessage('요약 보고서가 성공적으로 다운로드되었습니다!', 'success', document.getElementById('exportMessage'));
            } catch (error) {
                showMessage('요약 보고서 생성 중 오류가 발생했습니다: ' + error.message, 'error', document.getElementById('exportMessage'));
                console.error('Summary report error:', error);
            }
        }
