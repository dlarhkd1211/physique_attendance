<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>출석 관리 시스템</title>
    <!-- SortableJS 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        input, select, button {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }
        
        /* 뷰 전환 버튼 - PC와 모바일 모두 표시 */
        .view-toggle {
            display: block; /* 항상 표시 */
            text-align: center;
            margin-bottom: 20px;
        }
        
        .view-toggle button {
            margin: 0 5px;
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .view-toggle button.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        .view-toggle button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }
        
        /* 테이블 스타일 */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .attendance-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 11px;
            min-width: 60px;
        }
        
        .attendance-table td {
            padding: 10px 6px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            min-width: 60px;
        }
        
        .attendance-cell {
            cursor: pointer;
            user-select: none;
            font-weight: 600;
            transition: all 0.2s ease;
            border-radius: 4px;
            margin: 2px;
            padding: 8px;
            min-width: 40px;
            min-height: 40px;
            text-align: center;
            vertical-align: middle;
        }
        
        .attendance-cell:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .present {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }
        
        .absent {
            background: white;
            color: #333;
            border: 2px solid #dee2e6;
        }
        
        .pass {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        
        .fail {
            background-color: #ffebee;
            color: #c62828;
        }
        
        /* 멤버 선택 드롭다운 */
        .member-selector {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .member-selector select {
            min-width: 200px;
            font-size: 16px;
            padding: 12px 16px;
        }
        
        .member-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }
        
        /* 카드 뷰 내비게이션 */
        .card-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .nav-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            min-width: 80px;
        }
        
        .nav-button:hover {
            background: #5a67d8;
        }
        
        .nav-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .member-indicator {
            font-weight: bold;
            color: #333;
            text-align: center;
            flex: 1;
            margin: 0 15px;
        }
        
        /* 단일 카드 표시 */
        .single-card-container {
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .no-member-selected {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #ddd;
        }
        
        .no-member-selected h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .mobile-view {
            display: none;
        }
        
        .member-card-view {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        
        .member-card-view.fail {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        
        .member-card-view.pass {
            border-left-color: #28a745;
            background: #f8fff8;
        }
        
        .member-header-mobile {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .member-name-mobile {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .member-role-mobile {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .member-stats-mobile {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }
        
        .attendance-grid-mobile {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        
        .attendance-item-mobile {
            text-align: center;
            padding: 10px 5px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .attendance-item-mobile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .attendance-item-mobile.present {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border-color: #4caf50;
        }
        
        .attendance-item-mobile.absent {
            background: white;
            color: #333;
            border-color: #dee2e6;
        }
        
        .date-label-mobile {
            font-size: 0.7em;
            line-height: 1.2;
            margin-bottom: 5px;
        }
        
        .attendance-value-mobile {
            font-size: 1.1em;
            font-weight: bold;
        }
        
        /* 멤버 관리 */
        .member-management {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .member-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 80px;
            cursor: move;
            position: relative;
        }
        
        .member-info {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: 40px;
        }
        
        .member-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            min-width: 100px;
        }
        
        .member-role {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .member-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .member-actions button {
            padding: 8px 12px;
            font-size: 12px;
        }
        
        .drag-handle {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: move;
            color: #6c757d;
            font-size: 18px;
            padding: 5px;
        }
        
        .sortable-ghost {
            opacity: 0.3;
            background: #f8f9fa;
        }
        
        .sortable-drag {
            opacity: 0.6;
            transform: rotate(5deg);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        /* 모달 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        /* PC 버전 카드뷰 최적화 */
        @media (min-width: 769px) {
            .desktop-view {
                display: block; /* PC에서 기본값은 테이블 뷰 */
            }
            
            .mobile-view {
                display: none; /* PC에서 기본값은 카드뷰 숨김 */
            }
            
            /* PC에서 카드뷰가 선택된 경우 */
            .mobile-view.active {
                display: block;
            }
            
            .desktop-view.inactive {
                display: none;
            }
            
            /* PC 카드뷰 스타일 조정 */
            .member-card-view {
                max-width: 800px;
                margin: 0 auto 20px auto;
            }
            
            .single-card-container {
                min-height: 300px;
            }
            
            /* PC 네비게이션 버튼 크기 조정 */
            .card-navigation {
                max-width: 600px;
                margin: 0 auto 20px auto;
            }
            
            .nav-button {
                padding: 12px 20px;
                font-size: 16px;
                min-width: 100px;
            }
            
            /* PC 멤버 선택 드롭다운 */
            .member-selector {
                max-width: 400px;
                margin: 0 auto 20px auto;
            }
            
            .member-selector select {
                min-width: 250px;
                font-size: 16px;
            }
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .content {
                padding: 15px;
            }
            
            .section {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .controls > * {
                width: 100%;
            }
            
            input, select, button {
                padding: 12px;
                font-size: 16px;
            }
            
            /* 모바일에서는 기본적으로 카드 뷰 */
            .desktop-view {
                display: none;
            }
            
            .mobile-view {
                display: block;
            }
            
            .member-card {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
                padding: 15px;
            }
            
            .member-info {
                margin-left: 0;
                flex-direction: column;
                gap: 10px;
                align-items: center;
                text-align: center;
            }
            
            .member-actions {
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .drag-handle {
                position: static;
                transform: none;
                align-self: center;
                margin-bottom: 10px;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 출석 관리 시스템</h1>
            <p>효율적인 출석 관리를 위한 웹 시스템</p>
        </div>
        
        <div class="content">
            <!-- 월 선택 -->
            <div class="section">
                <h2>📅 월 선택 및 관리</h2>
                <div class="controls">
                    <label>년도:</label>
                    <input type="number" id="year" value="2024" min="2020" max="2030">
                    <label>월:</label>
                    <select id="month">
                        <option value="1">1월</option>
                        <option value="2">2월</option>
                        <option value="3">3월</option>
                        <option value="4">4월</option>
                        <option value="5">5월</option>
                        <option value="6" selected>6월</option>
                        <option value="7">7월</option>
                        <option value="8">8월</option>
                        <option value="9">9월</option>
                        <option value="10">10월</option>
                        <option value="11">11월</option>
                        <option value="12">12월</option>
                    </select>
                    <button onclick="loadCurrentMonth()">조회</button>
                    <button class="btn-success" onclick="copyFromPreviousMonth()">전월 멤버 복사</button>
                </div>
                <div id="monthMessage"></div>
            </div>
            
            <!-- 멤버 추가 -->
            <div class="section">
                <h2>👥 멤버 추가</h2>
                <div class="controls">
                    <input type="text" id="memberName" placeholder="이름을 입력하세요">
                    <select id="memberRole">
                        <option value="운영진">운영진</option>
                        <option value="페이서">페이서</option>
                        <option value="페이서 강남">페이서 강남</option>
                        <option value="포토">포토</option>
                    </select>
                    <button onclick="addMember()">멤버 추가</button>
                </div>
                <div id="memberMessage"></div>
            </div>
            
            <!-- 출석 현황 -->
            <div class="section">
                <h2>📊 출석 현황</h2>
                <div id="attendanceTable">
                    <div class="loading">출석 데이터를 불러오는 중입니다...</div>
                </div>
            </div>
            
            <!-- 멤버 관리 -->
            <div class="section">
                <h2>👤 멤버 관리</h2>
                <div id="memberManagement">
                    <div class="loading">멤버 목록을 불러오는 중입니다...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 역할 변경 모달 -->
    <div id="roleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>역할 변경</h3>
                <span class="close" onclick="closeRoleModal()">&times;</span>
            </div>
            <div>
                <p id="roleModalMemberName"></p>
                <select id="newRole">
                    <option value="운영진">운영진</option>
                    <option value="페이서">페이서</option>
                    <option value="페이서 강남">페이서 강남</option>
                    <option value="포토">포토</option>
                </select>
                <div style="margin-top: 20px;">
                    <button onclick="updateMemberRole()">변경</button>
                    <button class="btn-secondary" onclick="closeRoleModal()">취소</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        var currentYear = 2024;
        var currentMonth = 6;
        var currentMembers = {};
        var editingMember = null;
        var currentView = 'auto'; // 자동 감지 (모바일: card, PC: table)
        var selectedMemberIndex = 0; // 현재 선택된 멤버 인덱스
        var memberList = []; // 멤버 리스트 (정렬된)
        var userSelectedView = null; // 사용자가 직접 선택한 뷰 (null이면 기본값 사용)
        
        // 현재 환경이 모바일인지 확인
        function isMobile() {
            return window.innerWidth <= 768;
        }
        
        // 기본 뷰 결정 (모바일: card, PC: table)
        function getDefaultView() {
            return isMobile() ? 'card' : 'table';
        }
        
        // 현재 사용해야 할 뷰 결정
        function getCurrentView() {
            // 사용자가 직접 선택한 뷰가 있으면 그것 사용
            if (userSelectedView) {
                return userSelectedView;
            }
            // 없으면 환경에 맞는 기본값 사용
            return getDefaultView();
        }
        document.addEventListener('DOMContentLoaded', function() {
            var currentDate = new Date();
            currentYear = currentDate.getFullYear();
            currentMonth = currentDate.getMonth() + 1;
            
            document.getElementById('year').value = currentYear;
            document.getElementById('month').value = currentMonth;
            
            // Enter 키 처리
            document.getElementById('memberName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addMember();
                }
            });
            
            // 년도/월 변경 시 자동 조회
            document.getElementById('year').addEventListener('change', loadCurrentMonth);
            document.getElementById('month').addEventListener('change', loadCurrentMonth);
            
            // 초기 데이터 로드
            loadCurrentMonth();
        });
        
        // 현재 월 데이터 로드
        function loadCurrentMonth() {
            currentYear = parseInt(document.getElementById('year').value);
            currentMonth = parseInt(document.getElementById('month').value);
            loadMemberManagement();
            loadAttendanceTable();
        }
        
        // 전월 멤버 복사
        function copyFromPreviousMonth() {
            var messageDiv = document.getElementById('monthMessage');
            
            fetch('/api/copy_previous_month', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    showMessage('전월 멤버를 성공적으로 복사했습니다!', 'success', messageDiv);
                    // 전월 멤버 복사 후 첫 번째 멤버 선택
                    selectedMemberIndex = 0;
                    loadCurrentMonthWithSync();
                } else {
                    showMessage('전월 데이터가 없거나 복사에 실패했습니다.', 'error', messageDiv);
                }
            })
            .catch(function(error) {
                showMessage('네트워크 오류가 발생했습니다: ' + error, 'error', messageDiv);
            });
        }
        
        // 멤버 추가
        function addMember() {
            var name = document.getElementById('memberName').value.trim();
            var role = document.getElementById('memberRole').value;
            var messageDiv = document.getElementById('memberMessage');
            
            if (!name) {
                showMessage('이름을 입력해주세요.', 'error', messageDiv);
                return;
            }
            
            fetch('/api/add_member', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth,
                    name: name,
                    role: role
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    showMessage('멤버가 성공적으로 추가되었습니다!', 'success', messageDiv);
                    document.getElementById('memberName').value = '';
                    
                    // 멤버 추가 후 전체 업데이트 (순서 유지)
                    loadCurrentMonthWithSync();
                } else {
                    showMessage('멤버 추가에 실패했습니다: ' + (data.error || '알 수 없는 오류'), 'error', messageDiv);
                }
            })
            .catch(function(error) {
                showMessage('네트워크 오류가 발생했습니다: ' + error, 'error', messageDiv);
            });
        }
        
        // 멤버 삭제
        function deleteMember(name) {
            if (!confirm("'" + name + "' 멤버를 정말 삭제하시겠습니까?")) {
                return;
            }
            
            // 현재 선택된 멤버 저장
            var currentSelectedMemberName = null;
            if (memberList.length > 0 && selectedMemberIndex >= 0 && selectedMemberIndex < memberList.length) {
                currentSelectedMemberName = memberList[selectedMemberIndex];
            }
            
            fetch('/api/member/' + currentYear + '/' + currentMonth + '/' + encodeURIComponent(name), {
                method: 'DELETE'
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    // 삭제된 멤버가 현재 선택된 멤버인 경우 첫 번째 멤버로 변경
                    if (currentSelectedMemberName === name) {
                        selectedMemberIndex = 0;
                        loadCurrentMonthWithSync();
                    } else {
                        // 다른 멤버가 선택된 경우 선택 유지
                        loadCurrentMonthWithSync(currentSelectedMemberName);
                    }
                } else {
                    alert('멤버 삭제에 실패했습니다.');
                }
            })
            .catch(function(error) {
                alert('네트워크 오류가 발생했습니다: ' + error);
            });
        }
        
        // 역할 변경 완료 후 업데이트
        function updateMemberRole() {
            if (!editingMember) return;
            
            // 현재 선택된 멤버 저장
            var currentSelectedMemberName = null;
            if (memberList.length > 0 && selectedMemberIndex >= 0 && selectedMemberIndex < memberList.length) {
                currentSelectedMemberName = memberList[selectedMemberIndex];
            }
            
            var newRole = document.getElementById('newRole').value;
            
            fetch('/api/member_role', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth,
                    name: editingMember,
                    role: newRole
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    closeRoleModal();
                    // 역할 변경 후 선택 유지하면서 업데이트
                    loadCurrentMonthWithSync(currentSelectedMemberName);
                } else {
                    alert('역할 변경에 실패했습니다.');
                }
            })
            .catch(function(error) {
                alert('네트워크 오류가 발생했습니다: ' + error);
            });
        }
        
        // 멤버 관리와 출석 현황을 동기화하여 로드
        function loadCurrentMonthWithSync(selectedMemberName) {
            // 멤버 관리 먼저 로드
            loadMemberManagement();
            
            // 출석 현황을 선택된 멤버와 함께 로드
            if (selectedMemberName) {
                loadAttendanceTableWithMemberSelection(selectedMemberName);
            } else {
                loadAttendanceTable();
            }
        }
        
        // 역할 변경 모달
        function openRoleModal(name, currentRole) {
            editingMember = name;
            document.getElementById('roleModalMemberName').textContent = name + '의 역할 변경';
            document.getElementById('newRole').value = currentRole;
            document.getElementById('roleModal').style.display = 'block';
        }
        
        function closeRoleModal() {
            document.getElementById('roleModal').style.display = 'none';
            editingMember = null;
        }
        
        function updateMemberRole() {
            if (!editingMember) return;
            
            var newRole = document.getElementById('newRole').value;
            
            fetch('/api/member_role', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth,
                    name: editingMember,
                    role: newRole
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    closeRoleModal();
                    loadCurrentMonth();
                } else {
                    alert('역할 변경에 실패했습니다.');
                }
            })
            .catch(function(error) {
                alert('네트워크 오류가 발생했습니다: ' + error);
            });
        }
        
        // 멤버 관리 로드
        function loadMemberManagement() {
            var container = document.getElementById('memberManagement');
            container.innerHTML = '<div class="loading">멤버 목록을 불러오는 중입니다...</div>';
            
            fetch('/api/members/' + currentYear + '/' + currentMonth)
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                currentMembers = data;
                displayMemberManagement(data);
            })
            .catch(function(error) {
                container.innerHTML = '<div class="error">멤버 목록을 불러오는 중 오류가 발생했습니다: ' + error + '</div>';
            });
        }
        
        // 멤버 관리 화면 표시
        function displayMemberManagement(members) {
            var container = document.getElementById('memberManagement');
            
            if (Object.keys(members).length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><h3>등록된 멤버가 없습니다</h3><p>위의 "멤버 추가" 섹션에서 새 멤버를 추가하거나 "전월 멤버 복사" 버튼을 사용하세요.</p></div>';
                return;
            }
            
            // 멤버를 order 순으로 정렬
            var memberEntries = Object.keys(members);
            memberEntries.sort(function(a, b) {
                var orderA = members[a].order || 0;
                var orderB = members[b].order || 0;
                return orderA - orderB;
            });
            
            var html = '<div class="member-management" id="sortable-members">';
            
            for (var i = 0; i < memberEntries.length; i++) {
                var name = memberEntries[i];
                var member = members[name];
                
                html += '<div class="member-card" data-member-name="' + name + '">';
                html += '<div class="drag-handle" title="드래그하여 순서 변경">⋮⋮</div>';
                html += '<div class="member-info">';
                html += '<div class="member-name">' + name + '</div>';
                html += '<div class="member-role">' + member.role + '</div>';
                html += '</div>';
                html += '<div class="member-actions">';
                html += '<button class="btn-warning" onclick="openRoleModal(\'' + name + '\', \'' + member.role + '\')">역할 변경</button>';
                html += '<button class="btn-danger" onclick="deleteMember(\'' + name + '\')">삭제</button>';
                html += '</div>';
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
            
            // Sortable 초기화
            setTimeout(function() {
                initializeSortable();
            }, 100);
        }
        
        // Sortable 초기화
        function initializeSortable() {
            var memberContainer = document.querySelector('#sortable-members');
            
            if (!memberContainer) return;
            if (typeof Sortable === 'undefined') return;
            
            if (memberContainer.sortableInstance) {
                memberContainer.sortableInstance.destroy();
            }
            
            memberContainer.sortableInstance = Sortable.create(memberContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                handle: '.drag-handle',
                onEnd: function(evt) {
                    if (evt.oldIndex !== evt.newIndex) {
                        updateMemberOrderByDrag(evt.oldIndex, evt.newIndex);
                    }
                }
            });
        }
        
        // 드래그로 순서 변경
        function updateMemberOrderByDrag(oldIndex, newIndex) {
            var memberNames = Object.keys(currentMembers);
            memberNames.sort(function(a, b) {
                var orderA = currentMembers[a].order || 0;
                var orderB = currentMembers[b].order || 0;
                return orderA - orderB;
            });
            
            // 현재 선택된 멤버 이름 저장 (카드뷰용)
            var currentSelectedMemberName = null;
            if (memberList.length > 0 && selectedMemberIndex >= 0 && selectedMemberIndex < memberList.length) {
                currentSelectedMemberName = memberList[selectedMemberIndex];
            }
            
            // 배열에서 요소 이동
            var movedMember = memberNames.splice(oldIndex, 1)[0];
            memberNames.splice(newIndex, 0, movedMember);
            
            // 새로운 order 값들 생성
            var orders = [];
            for (var i = 0; i < memberNames.length; i++) {
                orders.push({
                    name: memberNames[i],
                    order: i
                });
            }
            
            // 서버에 업데이트 요청
            fetch('/api/member_orders', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth,
                    orders: orders
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    // 멤버 관리와 출석 현황 모두 업데이트
                    loadMemberManagement();
                    
                    // 출석 현황도 업데이트하되, 카드뷰에서 선택된 멤버 유지
                    loadAttendanceTableWithMemberSelection(currentSelectedMemberName);
                } else {
                    alert('순서 변경에 실패했습니다.');
                    loadCurrentMonth();
                }
            })
            .catch(function(error) {
                alert('네트워크 오류가 발생했습니다: ' + error);
                loadCurrentMonth();
            });
        }
        
        // 선택된 멤버를 유지하면서 출석 테이블 로드
        function loadAttendanceTableWithMemberSelection(selectedMemberName) {
            var container = document.getElementById('attendanceTable');
            container.innerHTML = '<div class="loading">출석 데이터를 불러오는 중입니다...</div>';
            
            fetch('/api/monthly_report/' + currentYear + '/' + currentMonth)
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                // 새로운 순서로 멤버 리스트 업데이트
                var memberEntries = Object.keys(data.members || data);
                memberEntries.sort(function(a, b) {
                    var dataObj = data.members || data;
                    var orderA = dataObj[a].order || 0;
                    var orderB = dataObj[b].order || 0;
                    return orderA - orderB;
                });
                
                // 이전에 선택된 멤버의 새로운 인덱스 찾기
                if (selectedMemberName && memberEntries.indexOf(selectedMemberName) !== -1) {
                    selectedMemberIndex = memberEntries.indexOf(selectedMemberName);
                } else {
                    // 이전 선택이 없거나 해당 멤버가 없으면 첫 번째 멤버 선택
                    selectedMemberIndex = 0;
                }
                
                displayAttendanceTable(data, currentYear, currentMonth);
            })
            .catch(function(error) {
                container.innerHTML = '<div class="error">데이터를 불러오는 중 오류가 발생했습니다: ' + error + '</div>';
            });
        }
        
        // 출석 테이블 로드
        function loadAttendanceTable() {
            var container = document.getElementById('attendanceTable');
            container.innerHTML = '<div class="loading">출석 데이터를 불러오는 중입니다...</div>';
            
            fetch('/api/monthly_report/' + currentYear + '/' + currentMonth)
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                displayAttendanceTable(data, currentYear, currentMonth);
            })
            .catch(function(error) {
                container.innerHTML = '<div class="error">데이터를 불러오는 중 오류가 발생했습니다: ' + error + '</div>';
            });
        }
        
        // 출석 테이블 표시
        function displayAttendanceTable(responseData, year, month) {
            var container = document.getElementById('attendanceTable');
            var data = responseData.members || responseData;
            var dates = responseData.dates || [];
            
            if (Object.keys(data).length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><h3>등록된 멤버가 없습니다</h3><p>위의 "멤버 추가" 섹션에서 새 멤버를 추가하거나 "전월 멤버 복사" 버튼을 사용하세요.</p></div>';
                return;
            }
            
            // 멤버를 order 순으로 정렬
            var memberEntries = Object.keys(data);
            memberEntries.sort(function(a, b) {
                var orderA = data[a].order || 0;
                var orderB = data[b].order || 0;
                return orderA - orderB;
            });
            
            // 날짜가 없으면 첫 번째 멤버의 출석 데이터에서 추출
            var finalDates = dates;
            if (finalDates.length === 0 && memberEntries.length > 0) {
                finalDates = Object.keys(data[memberEntries[0]].attendance || {}).sort();
            }
            
            var html = '';
            
            // 현재 사용할 뷰 결정
            var viewToUse = getCurrentView();
            
            // 뷰 토글 버튼 (PC와 모바일 모두 표시)
            html += '<div class="view-toggle">';
            
            if (viewToUse === 'table') {
                html += '<button id="tableViewBtn" class="active" onclick="switchToTableView()">📊 테이블 뷰</button>';
                html += '<button id="cardViewBtn" onclick="switchToCardView()">📋 카드 뷰</button>';
            } else {
                html += '<button id="tableViewBtn" onclick="switchToTableView()">📊 테이블 뷰</button>';
                html += '<button id="cardViewBtn" class="active" onclick="switchToCardView()">📋 카드 뷰</button>';
            }
            
            html += '</div>';
            
            // 데스크톱 테이블 뷰
            html += '<div class="desktop-view"' + (viewToUse === 'table' ? '' : ' style="display: none;"') + '>';
            html += generateTableView(data, memberEntries, finalDates, year, month);
            html += '</div>';
            
            // 모바일 카드 뷰
            html += '<div class="mobile-view"' + (viewToUse === 'card' ? '' : ' style="display: none;"') + '>';
            html += generateCardView(data, memberEntries, finalDates, year, month);
            html += '</div>';
            
            // 범례 추가
            html += '<div style="margin-top: 30px; padding: 25px; background: #f8f9fa; border-radius: 10px;">';
            html += '<h3>📋 출석 조건 및 사용법</h3>';
            html += '<ul style="list-style: none; margin: 15px 0;">';
            html += '<li style="padding: 5px 0;">▶ <strong>운영진:</strong> 출석 조건 없음</li>';
            html += '<li style="padding: 5px 0;">▶ <strong>페이서:</strong> 월 3회 이상 출석</li>';
            html += '<li style="padding: 5px 0;">▶ <strong>페이서 강남:</strong> 월 3회 이상 출석 (그 중 수요일 2회 이상)</li>';
            html += '<li style="padding: 5px 0;">▶ <strong>포토:</strong> 월 1회 이상 출석</li>';
            html += '</ul>';
            html += '<div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin-top: 15px; border-radius: 0 8px 8px 0;">';
            html += '<p style="margin: 5px 0; color: #1565c0;"><strong>💡 사용법:</strong></p>';
            html += '<p style="margin: 5px 0; color: #1565c0;">• 출석 셀을 클릭하면 출석/불참이 토글됩니다</p>';
            html += '<p style="margin: 5px 0; color: #1565c0;">• 초록색 배경: 출석 조건 충족 ✅</p>';
            html += '<p style="margin: 5px 0; color: #1565c0;">• 빨간색 배경: 출석 조건 미충족 ❌</p>';
            if (isMobile()) {
                html += '<p style="margin: 5px 0; color: #1565c0;">• 📱 모바일: 기본 카드 뷰, 멤버별 개별 확인</p>';
            } else {
                html += '<p style="margin: 5px 0; color: #1565c0;">• 🖥️ PC: 기본 테이블 뷰, 전체 한눈에 확인</p>';
            }
            html += '</div>';
            html += '</div>';
            
            container.innerHTML = html;
            
            // 현재 뷰 상태 설정
            currentView = viewToUse;
        }
        
        // 테이블 뷰 생성
        function generateTableView(data, memberEntries, finalDates, year, month) {
            var isMobile = window.innerWidth <= 768;
            var html = '';
            
            if (isMobile && finalDates.length > 4) {
                html += '<div style="text-align: center; color: #666; font-size: 0.9em; margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px;">📱 표를 좌우로 스크롤하여 모든 날짜를 확인하세요</div>';
            }
            
            html += '<div class="table-container">';
            html += '<table class="attendance-table">';
            
            // 헤더
            html += '<thead><tr>';
            html += '<th style="min-width: 60px;">직책</th>';
            html += '<th style="min-width: 80px;">성명</th>';
            html += '<th style="min-width: 50px;">합계</th>';
            
            for (var i = 0; i < finalDates.length; i++) {
                var date = finalDates[i];
                var dateObj = new Date(date);
                var weekdays = ['일', '월', '화', '수', '목', '금', '토'];
                var weekday = weekdays[dateObj.getDay()];
                var day = dateObj.getDate();
                html += '<th style="min-width: 50px;">' + month + '월<br>' + day + '일<br>' + weekday + '</th>';
            }
            html += '</tr></thead>';
            
            // 바디
            html += '<tbody>';
            for (var memberIndex = 0; memberIndex < memberEntries.length; memberIndex++) {
                var name = memberEntries[memberIndex];
                var info = data[name];
                
                if (!info || !info.stats) continue;
                
                var stats = info.stats;
                var rowClass = stats.meets_requirement ? 'pass' : 'fail';
                
                html += '<tr class="' + rowClass + '">';
                html += '<td><strong>' + (info.role || '미정') + '</strong></td>';
                html += '<td><strong>' + name + '</strong></td>';
                html += '<td><strong>' + (stats.total || 0) + '</strong></td>';
                
                for (var dateIndex = 0; dateIndex < finalDates.length; dateIndex++) {
                    var date = finalDates[dateIndex];
                    var attendance = info.attendance || {};
                    var status = attendance[date] || 0;
                    var cellClass = status === 1 ? 'present' : 'absent';
                    var displayText = status === 1 ? '1' : '0';
                    
                    html += '<td class="attendance-cell ' + cellClass + '" onclick="toggleAttendance(\'' + name + '\', \'' + date + '\', this)" title="' + name + ' - ' + date + ' 클릭하여 변경">';
                    html += displayText;
                    html += '</td>';
                }
                html += '</tr>';
            }
            html += '</tbody></table></div>';
            
            return html;
        }
        
        // 카드 뷰 생성 - 선택된 멤버만 표시
        function generateCardView(data, memberEntries, finalDates, year, month) {
            memberList = memberEntries; // 전역 변수에 저장
            
            var html = '';
            
            // 멤버 선택 드롭다운
            html += '<div class="member-selector">';
            html += '<label>👤 멤버 선택:</label>';
            html += '<select id="memberSelect" onchange="changeMember()">';
            for (var i = 0; i < memberEntries.length; i++) {
                var name = memberEntries[i];
                var selected = i === selectedMemberIndex ? ' selected' : '';
                html += '<option value="' + i + '"' + selected + '>' + name + '</option>';
            }
            html += '</select>';
            html += '</div>';
            
            // 네비게이션 버튼
            html += '<div class="card-navigation">';
            html += '<button class="nav-button" onclick="previousMember()" ' + (selectedMemberIndex <= 0 ? 'disabled' : '') + '>← 이전</button>';
            html += '<div class="member-indicator">' + (selectedMemberIndex + 1) + ' / ' + memberEntries.length + '</div>';
            html += '<button class="nav-button" onclick="nextMember()" ' + (selectedMemberIndex >= memberEntries.length - 1 ? 'disabled' : '') + '>다음 →</button>';
            html += '</div>';
            
            // 선택된 멤버 카드 표시
            html += '<div class="single-card-container">';
            
            if (memberEntries.length === 0) {
                html += '<div class="no-member-selected">';
                html += '<h3>등록된 멤버가 없습니다</h3>';
                html += '<p>멤버를 추가해주세요.</p>';
                html += '</div>';
            } else if (selectedMemberIndex >= 0 && selectedMemberIndex < memberEntries.length) {
                var name = memberEntries[selectedMemberIndex];
                var info = data[name];
                
                if (info && info.stats) {
                    var stats = info.stats;
                    var cardClass = stats.meets_requirement ? 'pass' : 'fail';
                    
                    html += '<div class="member-card-view ' + cardClass + '" style="width: 100%; max-width: 600px;">';
                    
                    // 멤버 헤더
                    html += '<div class="member-header-mobile">';
                    html += '<div class="member-name-mobile">' + name + '</div>';
                    html += '<div class="member-role-mobile">' + (info.role || '미정') + '</div>';
                    html += '</div>';
                    
                    // 통계
                    html += '<div class="member-stats-mobile">';
                    html += '<div class="stat-item">';
                    html += '<div class="stat-label">총 출석</div>';
                    html += '<div class="stat-value">' + (stats.total || 0) + '회</div>';
                    html += '</div>';
                    html += '<div class="stat-item">';
                    html += '<div class="stat-label">수요일 출석</div>';
                    html += '<div class="stat-value">' + (stats.wednesday || 0) + '회</div>';
                    html += '</div>';
                    html += '<div class="stat-item">';
                    html += '<div class="stat-label">조건 충족</div>';
                    html += '<div class="stat-value">' + (stats.meets_requirement ? '✅' : '❌') + '</div>';
                    html += '</div>';
                    html += '</div>';
                    
                    // 출석 그리드
                    html += '<div class="attendance-grid-mobile">';
                    for (var dateIndex = 0; dateIndex < finalDates.length; dateIndex++) {
                        var date = finalDates[dateIndex];
                        var dateObj = new Date(date);
                        var weekdays = ['일', '월', '화', '수', '목', '금', '토'];
                        var weekday = weekdays[dateObj.getDay()];
                        var day = dateObj.getDate();
                        
                        var attendance = info.attendance || {};
                        var status = attendance[date] || 0;
                        var itemClass = status === 1 ? 'present' : 'absent';
                        var displayText = status === 1 ? '출석' : '불참';
                        
                        html += '<div class="attendance-item-mobile ' + itemClass + '" onclick="toggleAttendance(\'' + name + '\', \'' + date + '\', this)" title="' + name + ' - ' + date + ' 클릭하여 변경">';
                        html += '<div class="date-label-mobile">' + month + '/' + day + '<br>' + weekday + '</div>';
                        html += '<div class="attendance-value-mobile">' + displayText + '</div>';
                        html += '</div>';
                    }
                    html += '</div>';
                    
                    html += '</div>';
                }
            }
            
            html += '</div>';
            
            return html;
        }
        
        // 멤버 네비게이션 함수들
        function previousMember() {
            if (selectedMemberIndex > 0) {
                selectedMemberIndex--;
                updateCardViewOnly(); // 카드뷰만 업데이트, 뷰 변경 안함
            }
        }
        
        function nextMember() {
            if (selectedMemberIndex < memberList.length - 1) {
                selectedMemberIndex++;
                updateCardViewOnly(); // 카드뷰만 업데이트, 뷰 변경 안함
            }
        }
        
        function changeMember() {
            var select = document.getElementById('memberSelect');
            if (select) {
                selectedMemberIndex = parseInt(select.value);
                updateCardViewOnly(); // 카드뷰만 업데이트, 뷰 변경 안함
            }
        }
        
        // 카드 뷰만 업데이트 (뷰 변경 없이)
        function updateCardViewOnly() {
            // 현재 선택된 멤버 이름 저장
            var currentSelectedMemberName = null;
            if (memberList.length > 0 && selectedMemberIndex >= 0 && selectedMemberIndex < memberList.length) {
                currentSelectedMemberName = memberList[selectedMemberIndex];
            }
            
            // 카드뷰 부분만 업데이트
            var mobileView = document.querySelector('.mobile-view');
            if (mobileView && currentView === 'card') {
                // 현재 데이터로 카드뷰 내용만 다시 생성
                fetch('/api/monthly_report/' + currentYear + '/' + currentMonth)
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    var memberEntries = Object.keys(data.members || data);
                    memberEntries.sort(function(a, b) {
                        var dataObj = data.members || data;
                        var orderA = dataObj[a].order || 0;
                        var orderB = dataObj[b].order || 0;
                        return orderA - orderB;
                    });
                    
                    var finalDates = data.dates || [];
                    if (finalDates.length === 0 && memberEntries.length > 0) {
                        finalDates = Object.keys((data.members || data)[memberEntries[0]].attendance || {}).sort();
                    }
                    
                    var cardViewHTML = generateCardView(data.members || data, memberEntries, finalDates, currentYear, currentMonth);
                    mobileView.innerHTML = cardViewHTML;
                })
                .catch(function(error) {
                    console.error('카드뷰 업데이트 오류:', error);
                });
            }
        }
        
        // 카드 뷰만 업데이트 (전체 테이블 다시 로드하지 않음)
        function updateCardView() {
            // 현재 선택된 멤버 이름 저장
            var currentSelectedMemberName = null;
            if (memberList.length > 0 && selectedMemberIndex >= 0 && selectedMemberIndex < memberList.length) {
                currentSelectedMemberName = memberList[selectedMemberIndex];
            }
            
            // 선택된 멤버를 유지하면서 출석 테이블 업데이트
            loadAttendanceTableWithMemberSelection(currentSelectedMemberName);
        }
        
        // 뷰 전환 함수들
        function switchToCardView() {
            var desktopView = document.querySelector('.desktop-view');
            var mobileView = document.querySelector('.mobile-view');
            var cardBtn = document.getElementById('cardViewBtn');
            var tableBtn = document.getElementById('tableViewBtn');
            
            if (desktopView) {
                desktopView.style.display = 'none';
                desktopView.classList.add('inactive');
            }
            if (mobileView) {
                mobileView.style.display = 'block';
                mobileView.classList.add('active');
            }
            if (cardBtn) cardBtn.classList.add('active');
            if (tableBtn) tableBtn.classList.remove('active');
            
            currentView = 'card';
            userSelectedView = 'card'; // 사용자가 직접 선택했음을 기록
            
            // 카드 뷰로 전환 시 첫 번째 멤버 선택 (인덱스가 범위를 벗어나는 경우만)
            if (selectedMemberIndex < 0 || selectedMemberIndex >= memberList.length) {
                selectedMemberIndex = 0;
            }
        }
        
        function switchToTableView() {
            var desktopView = document.querySelector('.desktop-view');
            var mobileView = document.querySelector('.mobile-view');
            var cardBtn = document.getElementById('cardViewBtn');
            var tableBtn = document.getElementById('tableViewBtn');
            
            if (desktopView) {
                desktopView.style.display = 'block';
                desktopView.classList.remove('inactive');
            }
            if (mobileView) {
                mobileView.style.display = 'none';
                mobileView.classList.remove('active');
            }
            if (tableBtn) tableBtn.classList.add('active');
            if (cardBtn) cardBtn.classList.remove('active');
            
            currentView = 'table';
            userSelectedView = 'table'; // 사용자가 직접 선택했음을 기록
        }
        
        // 출석 토글
        function toggleAttendance(name, date, cell) {
            var currentStatus = cell.classList.contains('present') ? 1 : 0;
            var newStatus = currentStatus === 1 ? 0 : 1;
            
            fetch('/api/attendance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth,
                    name: name,
                    date: date,
                    status: newStatus
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    // 즉시 셀 상태 업데이트
                    cell.classList.remove('present', 'absent');
                    cell.classList.add(newStatus === 1 ? 'present' : 'absent');
                    
                    // 텍스트 업데이트
                    var valueElement = cell.querySelector('.attendance-value-mobile');
                    if (valueElement) {
                        valueElement.textContent = newStatus === 1 ? '출석' : '불참';
                    } else {
                        cell.textContent = newStatus === 1 ? '1' : '0';
                    }
                    
                    // 통계 업데이트를 위해 테이블 다시 로드
                    setTimeout(function() {
                        loadAttendanceTable();
                    }, 100);
                } else {
                    alert('출석 정보 업데이트에 실패했습니다.');
                }
            })
            .catch(function(error) {
                alert('네트워크 오류가 발생했습니다: ' + error);
            });
        }
        
        // 메시지 표시
        function showMessage(message, type, container) {
            container.innerHTML = '<div class="' + type + '">' + message + '</div>';
            setTimeout(function() {
                container.innerHTML = '';
            }, 5000);
        }
        
        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            var modal = document.getElementById('roleModal');
            if (event.target === modal) {
                closeRoleModal();
            }
        };
    </script>
</body>
</html>